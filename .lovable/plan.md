
# 修复标准模式下财富简报生成必须先询问用户

## 问题诊断

### 现象
用户在财富教练对话结束时，希望 AI 先询问"是否要生成财富简报"，而不是直接生成。

### 根本原因
当前代码中**两种模式处理不一致**：

| 模式 | 当前行为 | 用户期望 |
|------|---------|---------|
| 冥想分析模式 (`meditation_analysis`) | ✅ 先询问用户是否生成 | 正确 |
| 标准四问法模式 (`standard`) | ❌ 完成后直接生成 | 需要修改 |

**问题代码位置** - `supabase/functions/wealth_coach_4_questions-coach/index.ts` 第 789 行：
```typescript
【完成条件】当四问全部完成后，调用 generate_wealth_briefing 工具生成财富日记。
```
此处直接调用工具，未要求先询问用户。

---

## 修复方案

### 修改 Edge Function 的标准模式 Prompt

**文件**: `supabase/functions/wealth_coach_4_questions-coach/index.ts`

**修改位置**: 第 789 行附近，标准四问法模式的完成条件

**修改内容**: 将直接调用改为先询问用户

```typescript
// 修改前
【完成条件】当四问全部完成后，调用 generate_wealth_briefing 工具生成财富日记。

// 修改后
【完成条件】
当四问全部完成后：
1. 先询问用户："你愿意让我把今天的觉察整理成一份《财富觉醒简报》吗？✨"
2. 只有用户明确同意后，才输出"好的，让我帮你整理今天的成长记录..."并调用 generate_wealth_briefing 工具
3. 如果用户拒绝或犹豫，尊重用户的选择，可以继续聊天或友好道别
```

---

## 数据流对比

```text
【修改前 - 标准模式】
四问完成
    │
    └─→ 直接调用 generate_wealth_briefing ❌ 用户无选择权

【修改后 - 标准模式】
四问完成
    │
    └─→ 询问"是否生成简报？"
          │
          ├─ 用户同意 → 调用工具生成
          │
          └─ 用户拒绝 → 尊重选择，不生成
```

---

## 影响范围

- **修改文件**: 1 个 (`supabase/functions/wealth_coach_4_questions-coach/index.ts`)
- **修改行数**: 约 10 行
- **风险评估**: 低风险，仅修改 prompt 文案
- **兼容性**: 冥想分析模式已有此逻辑，标准模式补齐即可

---

## 测试要点

1. 从首页直接进入财富教练（标准四问法模式）
2. 完成四个问题的对话
3. 验证 AI 是否询问"是否生成简报"
4. 回答"好"后，验证日记是否正常生成
5. 回答"不用了"后，验证 AI 是否友好结束对话

