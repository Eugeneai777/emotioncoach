
# AIæƒ…ç»ªæ•™ç»ƒå‡çº§ï¼šå¥—ç”¨æƒ…ç»ªå››éƒ¨æ›² + ç®€æŠ¥ç”Ÿæˆ + ä½¿ç”¨é™åˆ¶

## èƒŒæ™¯åˆ†æ

### å½“å‰æ¶æ„å¯¹æ¯”

| æ¨¡å— | AssessmentCoachChatï¼ˆæµ‹è¯„åå¯¹è¯ï¼‰ | emotion-coachï¼ˆæ•™ç»ƒç©ºé—´ï¼‰ |
|------|-----------------------------------|---------------------------|
| **æç¤ºè¯æ¥æº** | ç¡¬ç¼–ç åœ¨Edge Functionä¸­ | ä»`coach_templates`è¡¨åŠ¨æ€è¯»å– |
| **å¯¹è¯ç»“æ„** | ç®€å•4è½®å¯¹è¯ï¼ˆå…±æƒ…â†’è§‰é†’â†’è¡ŒåŠ¨â†’è½¬åŒ–ï¼‰ | å®Œæ•´æƒ…ç»ªå››éƒ¨æ›²ï¼ˆè§‰å¯Ÿâ†’ç†è§£â†’ååº”â†’è½¬åŒ–ï¼‰ |
| **é˜¶æ®µæ¨è¿›** | åŸºäºæ¶ˆæ¯è®¡æ•°è‡ªåŠ¨åˆ¤æ–­ | åŸºäºAIå·¥å…·è°ƒç”¨`complete_stage`ç²¾å‡†æ§åˆ¶ |
| **ç®€æŠ¥ç”Ÿæˆ** | æ— ç®€æŠ¥åŠŸèƒ½ | å®Œæ•´ç®€æŠ¥ç³»ç»Ÿï¼ˆgenerate_briefingå·¥å…·ï¼‰ |
| **ä¼šè¯ç®¡ç†** | æ— æŒä¹…åŒ– | `emotion_coaching_sessions`è¡¨æŒä¹…åŒ– |
| **é¢åº¦æ§åˆ¶** | æ—  | é€šè¿‡`deduct-quota`å‡½æ•°æ§åˆ¶ |

### ç›®æ ‡

1. **å¥—ç”¨æƒ…ç»ªæ•™ç»ƒprompt**ï¼šAssessmentCoachChatä½¿ç”¨ä¸æ•™ç»ƒç©ºé—´ç›¸åŒçš„`coach_templates.emotion`é…ç½®
2. **å®Œæ•´å››éƒ¨æ›²æµç¨‹**ï¼šç»è¿‡è§‰å¯Ÿâ†’ç†è§£â†’ååº”â†’è½¬åŒ–çš„ç»“æ„åŒ–æ—…ç¨‹
3. **ç”Ÿæˆç®€æŠ¥**ï¼šå®Œæˆåå¯ç”Ÿæˆæƒ…ç»ªç®€æŠ¥å¹¶ä¿å­˜
4. **é™åˆ¶ä½¿ç”¨æ¬¡æ•°**ï¼šå…è´¹ç”¨æˆ·åªèƒ½ç”Ÿæˆä¸€æ¬¡ç®€æŠ¥ï¼Œç»§ç»­ä½¿ç”¨éœ€è´­ä¹°æœ‰åŠ²365æˆ–è®­ç»ƒè¥

## å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

**æ¨èæ–¹æ¡ˆï¼šå¤ç”¨ `emotion-coach` Edge Function**

ç›´æ¥å¤ç”¨ç°æœ‰çš„`supabase/functions/emotion-coach/index.ts`ï¼Œè€Œä¸æ˜¯é‡å†™`assessment-coach-chat`ã€‚ç†ç”±ï¼š

1. **ä»£ç å¤ç”¨**ï¼šæƒ…ç»ªå››éƒ¨æ›²é€»è¾‘ã€é˜¶æ®µæ¨è¿›ã€ç®€æŠ¥ç”Ÿæˆã€é¢åº¦æ§åˆ¶å·²ç»å®Œå–„
2. **ç»Ÿä¸€ç»´æŠ¤**ï¼šPromptæ›´æ–°åªéœ€ä¿®æ”¹ä¸€å¤„ï¼ˆ`coach_templates`è¡¨ï¼‰
3. **å‡å°‘Bug**ï¼šé¿å…ä¸¤å¥—é€»è¾‘å¯¼è‡´çš„ä¸ä¸€è‡´é—®é¢˜

---

## æŠ€æœ¯å®æ–½è®¡åˆ’

### 1. æ–°å»ºEdge Functionï¼š`assessment-emotion-coach`

åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºæµ‹è¯„åå¯¹è¯çš„Edge Functionï¼ŒåŸºäº`emotion-coach`çš„é€»è¾‘ä½†æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š

**æ–‡ä»¶**ï¼š`supabase/functions/assessment-emotion-coach/index.ts`

**æ ¸å¿ƒé€»è¾‘**ï¼š
```text
è¯·æ±‚å‚æ•°ï¼š
- pattern: æµ‹è¯„ç»“æœçš„æƒ…ç»ªæ¨¡å¼ï¼ˆå¦‚"exhaustion"ï¼‰
- patternName: æ¨¡å¼åç§°ï¼ˆå¦‚"è€—ç«­å‹"ï¼‰
- sessionId: ä¼šè¯IDï¼ˆå¯é€‰ï¼Œé¦–æ¬¡ä¸ºç©ºï¼‰
- message: ç”¨æˆ·æ¶ˆæ¯

æµç¨‹ï¼š
1. é¦–æ¬¡è¯·æ±‚æ—¶åˆ›å»º emotion_coaching_sessions è®°å½•
   - æ ‡è®° source = 'assessment'
   - å°† pattern ä¿¡æ¯å­˜å…¥ metadata

2. æ£€æŸ¥ç®€æŠ¥ç”Ÿæˆæ¬¡æ•°é™åˆ¶
   - æŸ¥è¯¢ user_free_quota_usage è¡¨
   - feature_type = 'assessment_emotion_briefing'
   - free_quota_period = 'one_time'
   - å¦‚æœå·²ä½¿ç”¨ä¸”æ— ä¼šå‘˜æƒç›Š â†’ è¿”å› 402

3. å¤ç”¨ emotion-coach çš„æ ¸å¿ƒé€»è¾‘
   - ä» coach_templates åŠ è½½ emotion çš„ stage_prompts
   - ä½¿ç”¨ç›¸åŒçš„ buildStagePrompt å‡½æ•°
   - æ³¨å…¥æµ‹è¯„ç»“æœä½œä¸ºä¸Šä¸‹æ–‡

4. å®Œæˆåç”Ÿæˆç®€æŠ¥
   - è°ƒç”¨ generate_briefing å·¥å…·
   - ä¿å­˜åˆ° briefings è¡¨
   - æ‰£é™¤å…è´¹é¢åº¦
```

### 2. ä¿®æ”¹ AssessmentCoachChat ç»„ä»¶

**æ–‡ä»¶**ï¼š`src/components/emotion-health/AssessmentCoachChat.tsx`

```text
ä¸»è¦æ”¹åŠ¨ï¼š
1. API ç«¯ç‚¹åˆ‡æ¢
   - ä» assessment-coach-chat â†’ assessment-emotion-coach

2. ä¼šè¯ç®¡ç†
   - é¦–æ¬¡è¿›å…¥æ—¶åˆ›å»ºä¼šè¯ï¼Œè·å– sessionId
   - åç»­è¯·æ±‚æºå¸¦ sessionId

3. é˜¶æ®µè¿›åº¦æ˜¾ç¤º
   - æ·»åŠ  UnifiedStageProgress ç»„ä»¶
   - æ˜¾ç¤ºå½“å‰åœ¨å››éƒ¨æ›²çš„å“ªä¸ªé˜¶æ®µ

4. ç®€æŠ¥ç”ŸæˆUI
   - æ£€æµ‹ tool_call = 'generate_briefing'
   - æ˜¾ç¤ºç®€æŠ¥ç¡®è®¤å¡ç‰‡
   - ç‚¹å‡»åæ¸²æŸ“ ParentJourneySummary ç»„ä»¶

5. é™åˆ¶æç¤º
   - 402 é”™è¯¯æ—¶æ˜¾ç¤ºè´­ä¹°æç¤º
   - å¼•å¯¼è‡³æœ‰åŠ²365æˆ–è®­ç»ƒè¥è´­ä¹°é¡µ
```

### 3. æ•°æ®åº“é…ç½®

**æ–°å¢ `feature_definitions` è®°å½•**ï¼š
```sql
INSERT INTO feature_definitions (feature_key, feature_name, category)
VALUES ('assessment_emotion_briefing', 'æµ‹è¯„æƒ…ç»ªç®€æŠ¥', 'services');
```

**é…ç½® `package_feature_settings`**ï¼š
```sql
-- æ— å¥—é¤ç”¨æˆ·ï¼š1æ¬¡å…è´¹ï¼Œä¹‹åéœ€ä»˜è´¹
INSERT INTO package_feature_settings (package_id, feature_id, free_quota, free_quota_period, cost_per_use)
SELECT NULL, id, 1, 'one_time', 10
FROM feature_definitions WHERE feature_key = 'assessment_emotion_briefing';

-- æœ‰åŠ²365å¥—é¤ï¼šæ— é™ä½¿ç”¨
INSERT INTO package_feature_settings (package_id, feature_id, free_quota, free_quota_period, cost_per_use)
SELECT p.id, fd.id, 999, 'lifetime', 0
FROM packages p, feature_definitions fd
WHERE p.package_key = 'youjin_365' AND fd.feature_key = 'assessment_emotion_briefing';

-- æƒ…ç»ªæ—¥è®°è®­ç»ƒè¥æƒç›Šï¼šæ— é™ä½¿ç”¨
-- é€šè¿‡ camp_entitlements ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæ•ˆ
```

### 4. Edge Function è¯¦ç»†è®¾è®¡

```text
supabase/functions/assessment-emotion-coach/index.ts

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯·æ±‚å¤„ç†æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. è®¤è¯æ£€æŸ¥                                                    â”‚
â”‚     â””â”€ è·å–ç”¨æˆ·ä¿¡æ¯                                             â”‚
â”‚                                                                 â”‚
â”‚  2. ä¼šè¯ç®¡ç†                                                    â”‚
â”‚     â”œâ”€ æ—  sessionId â†’ åˆ›å»ºæ–°ä¼šè¯                                â”‚
â”‚     â”‚   â””â”€ æ£€æŸ¥ç®€æŠ¥é™é¢ï¼ˆdeduct-quotaï¼‰                         â”‚
â”‚     â”‚       â”œâ”€ æœ‰å…è´¹é¢åº¦/ä¼šå‘˜ â†’ ç»§ç»­                           â”‚
â”‚     â”‚       â””â”€ æ— é¢åº¦ â†’ è¿”å› 402 + è´­ä¹°å¼•å¯¼                     â”‚
â”‚     â””â”€ æœ‰ sessionId â†’ åŠ è½½ç°æœ‰ä¼šè¯                              â”‚
â”‚                                                                 â”‚
â”‚  3. åŠ è½½é…ç½®                                                    â”‚
â”‚     â”œâ”€ coach_templates.emotion.stage_prompts                   â”‚
â”‚     â””â”€ coach_templates.emotion.system_prompt                   â”‚
â”‚                                                                 â”‚
â”‚  4. æ„å»ºç³»ç»Ÿæç¤ºè¯                                              â”‚
â”‚     â”œâ”€ åŸºç¡€ system_prompt                                       â”‚
â”‚     â”œâ”€ æ³¨å…¥æµ‹è¯„ç»“æœä¸Šä¸‹æ–‡                                       â”‚
â”‚     â”‚   â””â”€ "ç”¨æˆ·åˆšå®Œæˆæƒ…ç»ªå¥åº·æµ‹è¯„ï¼Œç»“æœä¸º'{patternName}'æ¨¡å¼"  â”‚
â”‚     â”œâ”€ å½“å‰é˜¶æ®µæç¤ºè¯ï¼ˆbuildStagePromptï¼‰                       â”‚
â”‚     â””â”€ é˜¶æ®µè½®æ•°æ§åˆ¶                                             â”‚
â”‚                                                                 â”‚
â”‚  5. è°ƒç”¨ AI å¹¶å¤„ç†å·¥å…·è°ƒç”¨                                      â”‚
â”‚     â”œâ”€ complete_stage â†’ æ›´æ–°é˜¶æ®µï¼Œç»§ç»­å¯¹è¯                      â”‚
â”‚     â””â”€ generate_briefing â†’ ä¿å­˜ç®€æŠ¥ï¼Œæ ‡è®°é¢åº¦å·²ç”¨               â”‚
â”‚                                                                 â”‚
â”‚  6. è¿”å›å“åº”                                                    â”‚
â”‚     â”œâ”€ content: AI å›å¤å†…å®¹                                     â”‚
â”‚     â”œâ”€ tool_call: å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆç”¨äºå‰ç«¯å¤„ç†ï¼‰                  â”‚
â”‚     â”œâ”€ current_stage: å½“å‰é˜¶æ®µï¼ˆ0-5ï¼‰                           â”‚
â”‚     â””â”€ session_id: ä¼šè¯ID                                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. å‰ç«¯ç»„ä»¶ç»“æ„

```text
AssessmentCoachChat.tsx æ”¹é€ åç»“æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pattern Badge                                                  â”‚
â”‚  [ğŸ”¥ è€—ç«­å‹] Â· æƒ…ç»ªå››éƒ¨æ›²è¿›è¡Œä¸­                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  UnifiedStageProgress                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚è§‰å¯Ÿ â”‚â”€â”€â”‚ç†è§£ â”‚â”€â”€â”‚ååº” â”‚â”€â”€â”‚è½¬åŒ– â”‚                            â”‚
â”‚  â”‚ âœ“  â”‚  â”‚ â—  â”‚  â”‚ â—‹  â”‚  â”‚ â—‹  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  èŠå¤©æ¶ˆæ¯åŒºåŸŸ                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸŒ¿ åŠ²è€å¸ˆ                                                  â”‚ â”‚
â”‚  â”‚ ä½ å¥½ï¼çœ‹åˆ°ä½ åˆšå®Œæˆäº†æµ‹è¯„ï¼Œç»“æœæ˜¾ç¤ºä½ æ­£å¤„äº"è€—ç«­å‹"æ¨¡å¼...  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                              ç”¨æˆ·æ¶ˆæ¯       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  ... æ›´å¤šå¯¹è¯ ...                                               â”‚
â”‚                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                 â”‚
â”‚  ã€ç®€æŠ¥ç¡®è®¤å¡ç‰‡ã€‘ï¼ˆå®Œæˆå››éƒ¨æ›²åæ˜¾ç¤ºï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ¨ ä½ å¤ªæ£’äº†ï¼å®Œæˆäº†ä»Šå¤©çš„æƒ…ç»ªå››éƒ¨æ›²                        â”‚ â”‚
â”‚  â”‚ è¦ä¸è¦ç”Ÿæˆä¸€ä»½ä¸“å±ç®€æŠ¥ï¼Œè®°å½•è¿™æ¬¡çš„æˆé•¿ï¼Ÿ                   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚              [ğŸ’œ ç”Ÿæˆç®€æŠ¥]                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  ã€ç®€æŠ¥å±•ç¤ºã€‘ï¼ˆç”Ÿæˆåæ˜¾ç¤ºï¼‰                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ParentJourneySummary ç»„ä»¶                                  â”‚ â”‚
â”‚  â”‚ - ä»Šæ—¥ä¸»é¢˜æƒ…ç»ª                                             â”‚ â”‚
â”‚  â”‚ - å››éƒ¨æ›²æ—…ç¨‹è®°å½•                                           â”‚ â”‚
â”‚  â”‚ - ä»Šæ—¥æ´å¯Ÿ                                                 â”‚ â”‚
â”‚  â”‚ - ä»Šæ—¥è¡ŒåŠ¨                                                 â”‚ â”‚
â”‚  â”‚ - ä»Šæ—¥æˆé•¿æ•…äº‹                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  ã€è´­ä¹°æ¨èå¡ç‰‡ã€‘ï¼ˆç®€æŠ¥ç”Ÿæˆåæ˜¾ç¤ºï¼‰                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ æƒ³è¦æŒç»­è·å¾—AIé™ªä¼´ï¼Ÿ                                    â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚ â”‚
â”‚  â”‚ â”‚ 21å¤©è®­ç»ƒè¥  â”‚  â”‚ æœ‰åŠ²365    â”‚                          â”‚ â”‚
â”‚  â”‚ â”‚ Â¥299       â”‚  â”‚ Â¥365/å¹´    â”‚                          â”‚ â”‚
â”‚  â”‚ â”‚ [äº†è§£è¯¦æƒ…] â”‚  â”‚ [äº†è§£è¯¦æƒ…] â”‚                          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¾“å…¥åŒºåŸŸ                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è¯´è¯´ä½ çš„æƒ³æ³•...                               â”‚  â”‚ ğŸ“¤ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. 402 é™åˆ¶å¤„ç†

```text
å½“ç”¨æˆ·å·²ç”¨å®Œå…è´¹ç®€æŠ¥é¢åº¦ä¸”æ— ä¼šå‘˜æ—¶ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     ğŸ˜” ä½“éªŒå·²ç»“æŸ                          â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  ä½ å·²ç»ä½¿ç”¨è¿‡ä¸€æ¬¡å…è´¹çš„AIæƒ…ç»ªæ•™ç»ƒç®€æŠ¥                      â”‚ â”‚
â”‚  â”‚  æƒ³è¦ç»§ç»­è·å¾—AIé™ªä¼´ï¼Œå¯ä»¥é€‰æ‹©ä»¥ä¸‹æ–¹å¼ï¼š                    â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ“” 21å¤©æƒ…ç»ªæ—¥è®°è®­ç»ƒè¥                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ æ¯å¤©ä¸€æ¬¡å®Œæ•´æƒ…ç»ªå››éƒ¨æ›²                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ AIç”Ÿæˆä¸“å±ç®€æŠ¥                                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ è®°å½•21å¤©çš„æƒ…ç»ªæˆé•¿è½¨è¿¹                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ é™æ—¶ä¼˜æƒ  Â¥299ï¼ˆåŸä»·Â¥399ï¼‰                            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚              [ç«‹å³åŠ å…¥ â†’]                             â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸŒŸ æœ‰åŠ²365ä¼šå‘˜                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ å…¨å¹´æ— é™æ¬¡ä½¿ç”¨æ‰€æœ‰AIæ•™ç»ƒ                           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ æ¯æœˆè¯¾ç¨‹å­¦ä¹ é¢åº¦                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ ä¸“å±æˆé•¿ç¤¾åŒº                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ Â¥365/å¹´                                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚              [äº†è§£è¯¦æƒ… â†’]                             â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `supabase/functions/assessment-emotion-coach/index.ts` | æµ‹è¯„åæƒ…ç»ªæ•™ç»ƒEdge Function |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨è¯´æ˜ |
|------|----------|
| `src/components/emotion-health/AssessmentCoachChat.tsx` | é‡æ„ä¸ºä½¿ç”¨æ–°Edge Functionï¼Œæ·»åŠ é˜¶æ®µè¿›åº¦ã€ç®€æŠ¥ç”Ÿæˆã€è´­ä¹°é™åˆ¶UI |
| `src/pages/AssessmentCoachPage.tsx` | å¯èƒ½éœ€è¦è°ƒæ•´å¸ƒå±€ä»¥å®¹çº³æ–°ç»„ä»¶ |
| `supabase/config.toml` | æ·»åŠ æ–°Edge Functioné…ç½® |

### æ•°æ®åº“å˜æ›´

| å˜æ›´ç±»å‹ | è¯´æ˜ |
|----------|------|
| INSERT | `feature_definitions` æ·»åŠ  `assessment_emotion_briefing` è®°å½• |
| INSERT | `package_feature_settings` é…ç½®å…è´¹é¢åº¦å’Œä¼šå‘˜æƒç›Š |

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. æµ‹è¯„ç»“æœæ³¨å…¥ç³»ç»Ÿæç¤ºè¯

```typescript
// åœ¨ assessment-emotion-coach ä¸­
const assessmentContext = `
ã€æµ‹è¯„èƒŒæ™¯ã€‘
ç”¨æˆ·åˆšå®Œæˆæƒ…ç»ªå¥åº·æµ‹è¯„ï¼Œç»“æœæ˜¾ç¤ºä¸º"${patternName}"æ¨¡å¼ã€‚
è¿™æ„å‘³ç€ç”¨æˆ·å¯èƒ½å­˜åœ¨ä»¥ä¸‹ç‰¹å¾ï¼š${getPatternDescription(pattern)}

è¯·åŸºäºè¿™ä¸ªèƒŒæ™¯ï¼Œæ¸©æŸ”åœ°å¼•å¯¼ç”¨æˆ·å¼€å§‹æƒ…ç»ªè§‰å¯Ÿçš„æ—…ç¨‹ã€‚
ç¬¬ä¸€è½®å¯¹è¯æ—¶ï¼Œå…ˆå…±æƒ…ç”¨æˆ·çš„å¤„å¢ƒï¼Œå†è‡ªç„¶è¿‡æ¸¡åˆ°æƒ…ç»ªå››éƒ¨æ›²ã€‚
`;

const systemPrompt = `${coachTemplate.system_prompt}

${assessmentContext}

ã€å½“å‰é˜¶æ®µ:${session.current_stage}/4ã€‘
${buildStagePrompt(...)}
`;
```

### 2. é¢åº¦æ£€æŸ¥æ—¶æœº

```typescript
// åœ¨ä¼šè¯åˆ›å»ºæ—¶æ£€æŸ¥ï¼Œè€Œä¸æ˜¯åœ¨ç”Ÿæˆç®€æŠ¥æ—¶æ£€æŸ¥
// è¿™æ ·å¯ä»¥æå‰å‘ŠçŸ¥ç”¨æˆ·é™åˆ¶ï¼Œé¿å…å®Œæˆå››éƒ¨æ›²åæ‰å‘ç°æ— æ³•ç”Ÿæˆç®€æŠ¥

if (isNewSession) {
  const quotaCheck = await checkQuota('assessment_emotion_briefing');
  if (!quotaCheck.allowed) {
    return { error: 'ä½“éªŒæ¬¡æ•°å·²ç”¨å®Œ', upsell: true };
  }
}
```

### 3. ç®€æŠ¥ä¿å­˜ä¸é¢åº¦æ‰£é™¤

```typescript
// ç”Ÿæˆç®€æŠ¥æ—¶
if (toolCall.function === 'generate_briefing') {
  // 1. ä¿å­˜ç®€æŠ¥åˆ° briefings è¡¨
  await saveBriefing(sessionId, briefingData);
  
  // 2. æ ‡è®°å…è´¹é¢åº¦å·²ä½¿ç”¨
  await markFreeQuotaUsed('assessment_emotion_briefing');
  
  // 3. è¿”å›ç®€æŠ¥æ•°æ®ç»™å‰ç«¯æ¸²æŸ“
  return { briefing: briefingData };
}
```

---

## å®æ–½é¡ºåº

1. **é˜¶æ®µä¸€ï¼šæ•°æ®åº“é…ç½®**ï¼ˆ5åˆ†é’Ÿï¼‰
   - æ·»åŠ  `feature_definitions` è®°å½•
   - é…ç½® `package_feature_settings`

2. **é˜¶æ®µäºŒï¼šEdge Function**ï¼ˆ30åˆ†é’Ÿï¼‰
   - åˆ›å»º `assessment-emotion-coach` å‡½æ•°
   - å¤ç”¨ `emotion-coach` çš„æ ¸å¿ƒé€»è¾‘
   - æ·»åŠ æµ‹è¯„ç»“æœä¸Šä¸‹æ–‡æ³¨å…¥
   - æ·»åŠ é¢åº¦æ£€æŸ¥é€»è¾‘

3. **é˜¶æ®µä¸‰ï¼šå‰ç«¯ç»„ä»¶**ï¼ˆ40åˆ†é’Ÿï¼‰
   - é‡æ„ `AssessmentCoachChat` ç»„ä»¶
   - æ·»åŠ é˜¶æ®µè¿›åº¦æ˜¾ç¤º
   - æ·»åŠ ç®€æŠ¥ç”Ÿæˆå’Œå±•ç¤ºUI
   - æ·»åŠ è´­ä¹°é™åˆ¶æç¤º

4. **é˜¶æ®µå››ï¼šæµ‹è¯•éªŒè¯**ï¼ˆ15åˆ†é’Ÿï¼‰
   - æµ‹è¯•å®Œæ•´å››éƒ¨æ›²æµç¨‹
   - æµ‹è¯•ç®€æŠ¥ç”Ÿæˆ
   - æµ‹è¯•é¢åº¦é™åˆ¶
   - æµ‹è¯•è´­ä¹°å¼•å¯¼è·³è½¬
