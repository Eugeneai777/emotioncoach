

## 财富语音教练升级：对话式引导 + 次数限制 + 个性化体验

### 改动总览

1. **重写提示词**：从死板的测评解说变为有温度的对话式教练，主动用名字称呼用户，挖掘财富目标与痛点
2. **次数限制**：免费 2 次对话，365 会员不限次数
3. **取消时长限制**：每次对话不限时间
4. **训练营具体价值描绘**：让用户知道训练营如何帮助达成目标

---

### 变更 1：重写 AI 提示词

**文件**：`supabase/functions/wealth-assessment-realtime-token/index.ts` 的 `buildWealthCoachInstructions` 函数

**新的对话策略（5 阶段自然流动，不告诉用户阶段）**：

| 阶段 | 核心目标 | 对话方式 |
|------|----------|----------|
| 1. 暖场自我介绍 + 精准共情 | 用名字称呼，自报"我是劲老师，你的财富觉醒教练"，用测评数据精准点出卡点 | "XX，你好！我是劲老师，你的财富觉醒教练。我们一起来为你的测评做个解读吧..." |
| 2. 目标与梦想探索 | 用开放式问题挖掘用户最渴望的财富目标 | "我很好奇，如果不考虑任何限制，你最想实现的财富目标是什么？" |
| 3. 痛点挖掘与卡点连接 | 将用户表达的迷茫/痛点与测评卡点关联，帮用户看见"为什么还没达成" | "你说想XX，而你的测评显示你在Y上有很深的卡点——这可能就是那股无形的阻力" |
| 4. 愿景描绘（90+分状态） | 具体描述突破后的状态，让用户向往 | 详见下方"90+分愿景" |
| 5. 训练营桥梁 | 用具体的训练营日程说明如何帮助用户达成刚才聊到的目标 | "训练营第X天的Y练习，就是专门帮你突破这个Z卡点的" |

**90+ 分愿景描绘**（注入提示词，让 AI 自然引用）：
- 面对金钱时内心平静安定，不再有"我不配"的声音
- 敢于为自己的价值定价，收入与自我认可同步增长
- 消费时从容理性——不再下意识说"太贵了"，而是问"这对我值不值"
- 看到机会时果断行动，不再因恐惧而犹豫错过
- 对财富有流动感和感恩感，而非匮乏感和焦虑感
- 能清晰看到财富与自身价值的关系，活出丰盛

**训练营具体价值映射**（按卡点匹配训练营内容）：
- 嘴穷 -> 训练营"语言重塑"模块：学会用丰盛语言替代匮乏语言
- 手穷 -> 训练营"行动突破"模块：从微行动开始建立财富行动力
- 眼穷 -> 训练营"视野拓展"模块：培养长远财富思维
- 心穷 -> 训练营"信念重塑"模块：重建"我值得拥有"的核心信念
- 以及 7 天冥想、财富日记、财富教练对话等具体工具

**对话风格要求**：
- 开场必须称呼用户名字 + 自我介绍"我是劲老师，你的财富觉醒教练"
- 每轮以开放式问题结尾，引导用户多分享
- 基于用户回答动态调整，而非按固定脚本
- 温暖、口语化、像老朋友聊天，2-4 句

---

### 变更 2：次数限制机制

**文件**：`src/components/wealth-block/AssessmentVoiceCoach.tsx`

新增逻辑：
1. 查询 `voice_chat_sessions` 表统计该用户的财富教练语音会话数量
2. 查询 `orders` 表判断是否有 `member365` 已付款订单
3. 按状态展示：
   - 未达上限（<2 次）：正常按钮 + "免费体验 还剩 X/2 次"
   - 已达上限且非 365 会员：按钮文案变为"升级 365 会员继续对话"，点击打开购买弹窗
   - 365 会员：正常使用，显示"🎖️ 365会员 无限对话"

**文件**：`supabase/functions/wealth-assessment-realtime-token/index.ts`

在生成 token 前增加后端校验：
1. 查询用户会话次数
2. 查询 365 会员状态
3. 超限且非会员：返回 `{ error: 'session_limit_reached' }` 拒绝生成 token

---

### 变更 3：取消时长限制

在 `AssessmentVoiceCoach.tsx` 的 `CoachVoiceChat` 组件中，确保 `featureKey` 对应的 `package_feature_settings` 中 `max_duration_minutes` 为 null。如果数据库中没有对应配置，`CoachVoiceChat` 默认使用 3 分钟限制，所以需要在组件层面覆盖（或确保数据库中该 feature 设置为 null）。

---

### 涉及文件

| 文件 | 变更 |
|------|------|
| `supabase/functions/wealth-assessment-realtime-token/index.ts` | 重写 `buildWealthCoachInstructions` 提示词 + 增加次数校验 |
| `src/components/wealth-block/AssessmentVoiceCoach.tsx` | 增加次数查询、365会员判断、UI 状态切换 |

### 技术细节

**次数统计查询**：
```sql
SELECT count(*) FROM voice_chat_sessions
WHERE user_id = $1 AND coach_key = '财富觉醒教练'
```

**365 会员判断**：
```sql
SELECT id FROM orders
WHERE user_id = $1 AND package_key = 'member365' AND status = 'paid'
LIMIT 1
```

**后端超限返回格式**：
```json
{
  "error": "session_limit_reached",
  "message": "免费对话次数已用完，升级365会员可无限对话",
  "used": 2,
  "limit": 2
}
```

**开场白示例**：
"小明，你好！我是劲老师，你的财富觉醒教练。我们一起来为你的测评做个解读吧！我看到你的财富健康度是 62 分，你最大的卡点在'嘴穷'上——就是在面对钱的时候，会不自觉地用语言否定自己的财富。你有没有类似的感觉？"

