
# 修复觉醒指数图表：两大核心问题

## 当前系统架构理解

```text
两套数据来源，互相独立：

GameProgressCard (78分+33)
└─ 读取 user_awakening_progress.current_awakening（数据库存储值）
   └─ 由 useEnsureAwakeningProgress 同步写入
      └─ 计算方式：最佳3天平均值

WealthProgressChart 统计栏（当前78，成长+33）← 已修复
└─ 实时从 entries 计算，最佳3天平均值
   └─ 与 GameProgressCard 匹配 ✅

WealthProgressChart 折线图（第1天=8分，第2天=0分）← 仍有问题
└─ 每天按单日评分瞬时计算
   └─ 评分1-2星 → 指数0-25分（贴近x轴） ← 视觉误导 ❌
```

## 两大问题根因

### 问题1：折线图低分点让用户困惑（第1天8分）

每日觉醒指数用公式 `((星数 - 1) / 4) × 100`：
- 1星 → 0分
- 2星 → 25分
- 3星 → 50分（中线）
- 4星 → 75分
- 5星 → 100分

训练营**初期用户**常见1-2星（正在觉察自己的卡点），第1天合理显示8分——这在数学上是正确的，但用户无法理解"我第1天8分、最后78分"这中间发生了什么。**图表缺乏解释层**。

### 问题2：第2天显示0分（无数据天）

某天只有文字梳理（无评分字段），`hasData=false`，折线图在此处断开（null）。但由于 Recharts 的 `connectNulls` 默认行为，断点在视觉上形成向0坠落的视觉误导。

实际上 `renderDot` 已经在 `!hasData` 时渲染了一个空心圆，但折线不经过这个点，**用户看到的是折线从某点跌到0，然后跳回**。

### 问题3：用户无法理解"为什么是78分"（当前展示最重要的缺失）

图表统计栏显示：起点 45，当前 78，成长 +33  
但折线图最后一天只有58分。用户的疑问：**"如果最后是58，为什么说当前78？"**

图表没有任何视觉说明告诉用户"78 = 最佳3天的平均峰值"。

---

## 解决方案（只修改 WealthProgressChart.tsx）

### 修复1：在统计栏"当前"旁添加算法说明标注

在 `awakeningStats.current` 旁边加一个小提示：

```
当前: 78  ⓘ（最佳3天均值）
```

点击或hover显示：
> 觉醒指数 = 记录中最好3天的平均分，确保你的进步被完整记住，不因某天状态波动而"倒退"

### 修复2：在统计栏"峰值"旁标注对应天数（已有）+ 补充说明折线展示逻辑

在统计栏下方（图表上方）添加一行小字说明：
> 折线图展示每日瞬时觉醒分，统计栏"当前"= 最佳3天均值

这样用户看到折线最后一天58分，和统计栏78分，会明白这是两种不同视角。

### 修复3：折线图在觉醒指数视图添加"峰值参考线"（ReferenceLine）

在折线图上叠加一条水平虚线标注"当前=78"（最佳3天均值），让用户在折线图中也能看到78分的"位置"在哪里。

```
Y轴: 100
       │           ───────────── 峰值 83 (第5天)
       │
  78   │ ................. 当前 78 (最佳3天均值)
       │        ●
  58   │    ●──────────────●   ← 最后一天实际值
       │  ●
  45   ●   ← 第0天起点
       └─────────────────────── 天数
```

这样用户一眼就能看出：折线点是瞬时值，虚线是当前指数（最佳3天均值），两者含义不同。

### 修复4：tooltip 显示日期信息时补充"此天觉醒分对当前指数的贡献"

当天分数 ≥ 最佳3天门槛时，tooltip 显示：
> ⭐ 此天纳入峰值计算

让用户理解哪几天"贡献"了自己的当前78分。

---

## 修改清单（仅 WealthProgressChart.tsx）

| 位置 | 修改内容 | 解决的问题 |
|------|----------|-----------|
| 统计栏"当前"旁 | 加"（最佳3天）"小标注 | 问题3：用户不明白78从哪来 |
| 统计栏下方 | 加一行灰色小字说明折线vs统计栏的区别 | 问题3：概念解释 |
| `<ReferenceLine>` | 新增一条水平虚线标注 `current_awakening`（78） | 问题3：折线图上也可视化78的位置 |
| CustomTooltip | 在 ≥ 最佳3天门槛的天显示"⭐ 纳入峰值计算" | 问题3：解释哪几天贡献了分数 |
| 折线无数据天 | `connectNulls={false}` 确认已设置（或设置） | 问题2：防止折线跌到0 |

---

## 修改效果

修改后用户看到：

```
[ ✨觉醒 | 行为 | 情绪 | 信念 ]

起点: 45    当前: 78 (最佳3天)    成长: +33    ⭐ 峰值: 83 (第5天)

💡 折线图展示每日瞬时分，"当前"= 记录中最好3天的平均峰值

[图表]
  - 折线：真实的每日波动（第1天8分、第7天58分）
  - 橙色虚线：当前指数 78（最佳3天均值，肯定你的进步）

[tooltip第5天]
  觉醒指数: 83分
  ⭐ 此天纳入峰值计算
```

这样图表本身就回答了"为什么是78，最后一天明明58"这个问题。
