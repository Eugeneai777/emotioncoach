# å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æŒ‡å—

è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½® IP ç™½åå•å’Œæµ‹è¯•æ¨é€åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

1. [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
2. [é…ç½®IPç™½åå•](#é…ç½®ipç™½åå•)
3. [é…ç½®åº”ç”¨è®¾ç½®](#é…ç½®åº”ç”¨è®¾ç½®)
4. [æµ‹è¯•æ¨é€åŠŸèƒ½](#æµ‹è¯•æ¨é€åŠŸèƒ½)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## å‰ç½®è¦æ±‚

åœ¨é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å°ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- âœ… ä»£ç†æœåŠ¡å™¨å·²æˆåŠŸéƒ¨ç½²
- âœ… æœåŠ¡å™¨å…¬ç½‘IPå·²è·å–
- âœ… æœåŠ¡å™¨é˜²ç«å¢™å’Œå®‰å…¨ç»„å·²é…ç½®
- âœ… æœåŠ¡è¿è¡Œæ­£å¸¸ï¼ˆé€šè¿‡ `./scripts/test-proxy.sh` éªŒè¯ï¼‰

## é…ç½®IPç™½åå•

### 1. è·å–æœåŠ¡å™¨å…¬ç½‘IP

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š

```bash
cd /opt/deployment-package
./scripts/get-ip.sh
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
========================================
  è·å–æœåŠ¡å™¨å…¬ç½‘IP
========================================

âœ… æœåŠ¡å™¨å…¬ç½‘IP:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   123.456.789.012
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**è®°å½•è¿™ä¸ªIPåœ°å€**ï¼Œä¸‹ä¸€æ­¥ä¼šç”¨åˆ°ã€‚

### 2. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°

1. è®¿é—®ï¼šhttps://mp.weixin.qq.com/
2. ä½¿ç”¨å¾®ä¿¡æ‰«ç ç™»å½•
3. é€‰æ‹©æ‚¨çš„å…¬ä¼—å·

### 3. è¿›å…¥åŸºæœ¬é…ç½®

å¯¼èˆªè·¯å¾„ï¼š
```
å·¦ä¾§èœå• â†’ è®¾ç½®ä¸å¼€å‘ â†’ åŸºæœ¬é…ç½®
```

æˆ–ç›´æ¥è®¿é—®ï¼š
```
https://mp.weixin.qq.com/advanced/advanced?action=interface&t=advanced/interface&token=YOUR_TOKEN&lang=zh_CN
```

### 4. æ‰¾åˆ°IPç™½åå•è®¾ç½®

åœ¨é¡µé¢ä¸­æ‰¾åˆ° **"IPç™½åå•"** éƒ¨åˆ†ï¼š

![IPç™½åå•ä½ç½®](å¦‚æœæœ‰æˆªå›¾å¯ä»¥æ”¾åœ¨è¿™é‡Œ)

### 5. æ·»åŠ IPåœ°å€

1. ç‚¹å‡» **"ä¿®æ”¹"** æŒ‰é’®

2. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼š
   - è¾“å…¥æœåŠ¡å™¨å…¬ç½‘IPï¼š`123.456.789.012`
   - å¦‚æœæœ‰å¤šä¸ªæœåŠ¡å™¨ï¼Œæ¯è¡Œä¸€ä¸ªIP
   - æ”¯æŒIPæ®µæ ¼å¼ï¼š`123.456.789.0/24`

3. ç‚¹å‡» **"ç¡®å®š"**

4. ä½¿ç”¨å¾®ä¿¡æ‰«ç ç¡®è®¤ä¿®æ”¹

### 6. éªŒè¯é…ç½®

**ç­‰å¾…1-2åˆ†é’Ÿ**è®©é…ç½®ç”Ÿæ•ˆï¼Œç„¶åæµ‹è¯•ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæµ‹è¯•å¾®ä¿¡API
curl "https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=YOUR_ACCESS_TOKEN"
```

å¦‚æœé…ç½®æˆåŠŸï¼Œåº”è¯¥è¿”å›ï¼š
```json
{
  "ip_list": ["..."]
}
```

è€Œä¸æ˜¯ï¼š
```json
{
  "errcode": 40164,
  "errmsg": "invalid ip xxx.xxx.xxx.xxx"
}
```

## é…ç½®åº”ç”¨è®¾ç½®

### 1. æ‰“å¼€åº”ç”¨

è®¿é—®æ‚¨çš„åº”ç”¨ï¼Œè¿›å…¥ **"è®¾ç½®"** é¡µé¢ã€‚

### 2. æ‰¾åˆ°å¾®ä¿¡å…¬ä¼—å·é…ç½®

æ»šåŠ¨åˆ° **"å¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯"** éƒ¨åˆ†ã€‚

### 3. è·å–è®¤è¯ä»¤ç‰Œ

å¦‚æœå¿˜è®°äº†ä¹‹å‰ç”Ÿæˆçš„ä»¤ç‰Œï¼Œåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š

```bash
cd /opt/deployment-package
cat .env | grep PROXY_AUTH_TOKEN
```

è¾“å‡ºï¼š
```
PROXY_AUTH_TOKEN=abcdefgh1234567890ABCDEFGH+/==
```

### 4. å¡«å†™ä»£ç†é…ç½®

å¯ç”¨ **"ä½¿ç”¨ä»£ç†æœåŠ¡å™¨"** å¼€å…³ï¼Œç„¶åå¡«å†™ï¼š

**ä»£ç†æœåŠ¡å™¨åœ°å€ï¼š**
```
http://123.456.789.012:3000
```
ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®é™…æœåŠ¡å™¨IPï¼‰

**ä»£ç†è®¤è¯ä»¤ç‰Œï¼š**
```
abcdefgh1234567890ABCDEFGH+/==
```
ï¼ˆç²˜è´´æ‚¨çš„å®é™…ä»¤ç‰Œï¼‰

### 5. ä¿å­˜è®¾ç½®

ç‚¹å‡» **"ä¿å­˜è®¾ç½®"** æŒ‰é’®ã€‚

## æµ‹è¯•æ¨é€åŠŸèƒ½

### 1. ä½¿ç”¨åº”ç”¨å†…æµ‹è¯•

1. åœ¨è®¾ç½®é¡µé¢ï¼Œæ‰¾åˆ° **"æµ‹è¯•æ¨é€"** æŒ‰é’®
2. ç‚¹å‡»æŒ‰é’®
3. æŸ¥çœ‹è¿”å›ç»“æœ

**æˆåŠŸç¤ºä¾‹ï¼š**
```
âœ… æ¨é€æˆåŠŸï¼
æ¶ˆæ¯ID: 1234567890
```

**å¤±è´¥ç¤ºä¾‹ï¼š**
```
âŒ æ¨é€å¤±è´¥
é”™è¯¯ä»£ç : 40164
é”™è¯¯ä¿¡æ¯: invalid ip xxx.xxx.xxx.xxx
```

### 2. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—

```bash
pm2 logs wechat-proxy --lines 50
```

æŸ¥æ‰¾æ¨é€è¯·æ±‚çš„æ—¥å¿—ï¼š
```
[2024-01-01 12:00:00] Proxying POST https://api.weixin.qq.com/cgi-bin/message/template/send
[2024-01-01 12:00:01] Response status: 200
```

### 3. æŸ¥çœ‹å¾®ä¿¡æ¶ˆæ¯

å¦‚æœæ¨é€æˆåŠŸï¼š
- è®¢é˜…ç”¨æˆ·ä¼šæ”¶åˆ°å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
- å¯ä»¥åœ¨å…¬ä¼—å·åå°çš„ "æ¨¡æ¿æ¶ˆæ¯" ä¸­æŸ¥çœ‹å‘é€è®°å½•

### 4. å¸¸è§æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šæé†’æ¶ˆæ¯æµ‹è¯•

```bash
# åœ¨åº”ç”¨ä¸­è§¦å‘ä¸€ä¸ªæé†’
# ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªæƒ…ç»ªè®°å½•

# æ£€æŸ¥æ˜¯å¦æ”¶åˆ°å¾®ä¿¡æé†’
```

#### åœºæ™¯2ï¼šç›®æ ‡è¾¾æˆé€šçŸ¥

```bash
# å®Œæˆä¸€ä¸ªæƒ…ç»ªç›®æ ‡
# åº”è¯¥æ”¶åˆ°ç¥è´ºæ¶ˆæ¯
```

#### åœºæ™¯3ï¼šæ‰¹é‡æ¨é€æµ‹è¯•

```bash
# æµ‹è¯•å¤šä¸ªç”¨æˆ·åŒæ—¶æ¥æ”¶æ¶ˆæ¯
# è§‚å¯ŸæœåŠ¡å™¨è´Ÿè½½å’Œå“åº”æ—¶é—´
```

## å¸¸è§é—®é¢˜

### Q1ï¼šIPç™½åå•æœ€å¤šå¯ä»¥æ·»åŠ å¤šå°‘ä¸ªï¼Ÿ

**A:** å¾®ä¿¡å…¬ä¼—å¹³å°æœ€å¤šæ”¯æŒæ·»åŠ  **20ä¸ªIPåœ°å€æˆ–IPæ®µ**ã€‚

### Q2ï¼šæ·»åŠ IPåå¤šä¹…ç”Ÿæ•ˆï¼Ÿ

**A:** é€šå¸¸ **1-2åˆ†é’Ÿ** å†…ç”Ÿæ•ˆï¼Œå»ºè®®ç¨ç­‰ç‰‡åˆ»å†æµ‹è¯•ã€‚

### Q3ï¼šå¯ä»¥ä½¿ç”¨IPæ®µå—ï¼Ÿ

**A:** å¯ä»¥ã€‚æ ¼å¼ç¤ºä¾‹ï¼š
- å•ä¸ªIPï¼š`123.456.789.012`
- IPæ®µï¼š`123.456.789.0/24` ï¼ˆå…è®¸ 123.456.789.0 ~ 123.456.789.255ï¼‰

### Q4ï¼šæœåŠ¡å™¨IPå˜åŒ–äº†æ€ä¹ˆåŠï¼Ÿ

**A:** 
1. è·å–æ–°çš„å…¬ç½‘IP
2. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ›´æ–°ç™½åå•
3. ç­‰å¾…1-2åˆ†é’Ÿ
4. æµ‹è¯•æ¨é€åŠŸèƒ½

### Q5ï¼šæ¨é€å¤±è´¥ï¼Œè¿”å› 40164 é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```json
{
  "errcode": 40164,
  "errmsg": "invalid ip xxx.xxx.xxx.xxx, not in whitelist hint: [...]"
}
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **ç¡®è®¤IPåœ°å€æ­£ç¡®**
   ```bash
   ./scripts/get-ip.sh
   ```

2. **æ£€æŸ¥ç™½åå•é…ç½®**
   - ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
   - æŸ¥çœ‹ IP ç™½åå•æ˜¯å¦åŒ…å«æœåŠ¡å™¨IP

3. **ç­‰å¾…ç”Ÿæ•ˆ**
   - åˆšä¿®æ”¹çš„ç™½åå•å¯èƒ½è¿˜æœªç”Ÿæ•ˆ
   - ç­‰å¾…2-5åˆ†é’Ÿ

4. **æ£€æŸ¥ä»£ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ**
   ```bash
   ./scripts/test-proxy.sh
   ```

5. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
   ```bash
   pm2 logs wechat-proxy | grep "40164"
   ```

### Q6ï¼šæ¨é€å¤±è´¥ï¼Œè¿”å› 401 é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```json
{
  "error": "Unauthorized"
}
```

**åŸå› ï¼š** è®¤è¯ä»¤ç‰Œä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥æœåŠ¡å™¨ä»¤ç‰Œ**
   ```bash
   cat /opt/deployment-package/.env | grep PROXY_AUTH_TOKEN
   ```

2. **æ£€æŸ¥åº”ç”¨é…ç½®**
   - ç¡®è®¤åº”ç”¨è®¾ç½®ä¸­çš„ä»¤ç‰Œä¸æœåŠ¡å™¨ä¸€è‡´
   - æ³¨æ„ï¼šä¸è¦æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œ

3. **é‡æ–°ç”Ÿæˆä»¤ç‰Œ**
   ```bash
   ./scripts/generate-token.sh
   ./scripts/deploy.sh
   ```

4. **æ›´æ–°åº”ç”¨é…ç½®**
   - å°†æ–°ä»¤ç‰Œå¡«å…¥åº”ç”¨è®¾ç½®
   - ä¿å­˜å¹¶é‡æ–°æµ‹è¯•

### Q7ï¼šæ”¶ä¸åˆ°å¾®ä¿¡æ¶ˆæ¯

**å¯èƒ½åŸå› ï¼š**

1. **ç”¨æˆ·æœªè®¢é˜…å…¬ä¼—å·**
   - åªæœ‰è®¢é˜…ç”¨æˆ·æ‰èƒ½æ”¶åˆ°æ¨¡æ¿æ¶ˆæ¯

2. **æ¨¡æ¿IDæœªé…ç½®**
   - æ£€æŸ¥åº”ç”¨è®¾ç½®ä¸­çš„æ¨¡æ¿IDæ˜¯å¦æ­£ç¡®

3. **ç”¨æˆ·å·²å–æ¶ˆå…³æ³¨**
   - å–æ¶ˆå…³æ³¨åæ— æ³•æ¥æ”¶æ¶ˆæ¯

4. **å¾®ä¿¡å®˜æ–¹é™åˆ¶**
   - æ¨¡æ¿æ¶ˆæ¯æœ‰é¢‘ç‡é™åˆ¶
   - å†…å®¹ä¸ç¬¦åˆè§„èŒƒä¼šè¢«æ‹¦æˆª

**è°ƒè¯•æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€
# åœ¨åº”ç”¨ä¸­æŸ¥çœ‹ç”¨æˆ·çš„å¾®ä¿¡ç»‘å®šçŠ¶æ€

# 2. æŸ¥çœ‹å‘é€è®°å½•
# å¾®ä¿¡å…¬ä¼—å¹³å° â†’ æ¨¡æ¿æ¶ˆæ¯ â†’ å‘é€è®°å½•

# 3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
pm2 logs wechat-proxy | grep "template/send"

# 4. æµ‹è¯• API è°ƒç”¨
curl -X POST http://localhost:3000/wechat-proxy \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "target_url": "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=YOUR_ACCESS_TOKEN",
    "method": "POST",
    "body": {
      "touser": "USER_OPENID",
      "template_id": "TEMPLATE_ID",
      "data": {
        "first": {"value": "æµ‹è¯•æ¶ˆæ¯"},
        "keyword1": {"value": "æµ‹è¯•å†…å®¹"},
        "remark": {"value": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"}
      }
    }
  }'
```

### Q8ï¼šå¦‚ä½•æŸ¥çœ‹æ¨é€å†å²ï¼Ÿ

**æ–¹æ³•1ï¼šå¾®ä¿¡å…¬ä¼—å¹³å°**
1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
2. è¿›å…¥ "æ¨¡æ¿æ¶ˆæ¯"
3. æŸ¥çœ‹ "å‘é€è®°å½•"

**æ–¹æ³•2ï¼šåº”ç”¨æ•°æ®åº“**
```sql
-- æŸ¥è¯¢æ¨¡æ¿æ¶ˆæ¯å‘é€è®°å½•
SELECT * FROM wechat_template_messages 
ORDER BY sent_at DESC 
LIMIT 100;
```

**æ–¹æ³•3ï¼šæœåŠ¡å™¨æ—¥å¿—**
```bash
# æŸ¥çœ‹æ‰€æœ‰æ¨é€è¯·æ±‚
pm2 logs wechat-proxy | grep "template/send"

# æŸ¥çœ‹æœ€è¿‘çš„æ¨é€
pm2 logs wechat-proxy --lines 100 | grep "Proxying POST"
```

## æœ€ä½³å®è·µ

### 1. ç›‘æ§æ¨é€æˆåŠŸç‡

åˆ›å»ºç›‘æ§è„šæœ¬ï¼š

```bash
cat > /opt/deployment-package/scripts/monitor-wechat.sh << 'EOF'
#!/bin/bash
LOG_FILE="/var/log/wechat-push-monitor.log"
TOTAL=$(pm2 logs wechat-proxy --nostream | grep "template/send" | wc -l)
SUCCESS=$(pm2 logs wechat-proxy --nostream | grep "Response status: 200" | wc -l)
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

if [ $TOTAL -gt 0 ]; then
  RATE=$((SUCCESS * 100 / TOTAL))
  echo "[$TIMESTAMP] Total: $TOTAL, Success: $SUCCESS, Rate: $RATE%" >> $LOG_FILE
fi
EOF

chmod +x /opt/deployment-package/scripts/monitor-wechat.sh

# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶ç»Ÿè®¡ï¼‰
(crontab -l; echo "0 * * * * /opt/deployment-package/scripts/monitor-wechat.sh") | crontab -
```

### 2. è®¾ç½®å‘Šè­¦

å½“æ¨é€å¤±è´¥ç‡è¿‡é«˜æ—¶å‘é€å‘Šè­¦ï¼š

```bash
# ç¼–è¾‘ç›‘æ§è„šæœ¬ï¼Œæ·»åŠ å‘Šè­¦é€»è¾‘
# ä¾‹å¦‚ï¼šæˆåŠŸç‡ä½äº90%æ—¶å‘é€é‚®ä»¶æˆ–çŸ­ä¿¡
```

### 3. å®šæœŸæ£€æŸ¥ç™½åå•

```bash
# æ¯æœˆç¡®è®¤IPç™½åå•æ˜¯å¦æ­£ç¡®
# ç‰¹åˆ«æ˜¯åœ¨æ›´æ¢æœåŠ¡å™¨å
```

### 4. å¤‡ä»½é…ç½®

```bash
# å®šæœŸå¤‡ä»½å¾®ä¿¡ç›¸å…³é…ç½®
# åŒ…æ‹¬ AppIDã€AppSecretã€æ¨¡æ¿IDç­‰
```

## ç›¸å…³æ–‡æ¡£

**å¾®ä¿¡å…¬ä¼—å¹³å°å®˜æ–¹æ–‡æ¡£ï¼š**
- [å¼€å‘è€…æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
- [æ¨¡æ¿æ¶ˆæ¯](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html)
- [IPç™½åå•](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)

**æµ‹è¯•å·¥å…·ï¼š**
- [å¾®ä¿¡å…¬ä¼—å¹³å°æ¥å£è°ƒè¯•å·¥å…·](https://mp.weixin.qq.com/debug/)

## è·å–å¸®åŠ©

å¦‚æœä»æœ‰é—®é¢˜ï¼š

1. æŸ¥çœ‹ [TROUBLESHOOTING.md](../TROUBLESHOOTING.md)
2. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š`pm2 logs wechat-proxy`
3. æŸ¥çœ‹å¾®ä¿¡å…¬ä¼—å¹³å°çš„æ¥å£è°ƒç”¨è®°å½•
4. è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š`./scripts/test-proxy.sh`

---

**é…ç½®å®Œæˆï¼** ğŸ‰ äº«å—ä¾¿æ·çš„å¾®ä¿¡æ¨é€æœåŠ¡ï¼
