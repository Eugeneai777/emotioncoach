# è¯¦ç»†éƒ¨ç½²æ–‡æ¡£

å®Œæ•´çš„å¾®ä¿¡APIä»£ç†æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—ã€‚

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
2. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
3. [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
4. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
5. [éªŒè¯æµ‹è¯•](#éªŒè¯æµ‹è¯•)
6. [ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–](#ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–)

## ç³»ç»Ÿè¦æ±‚

### æœåŠ¡å™¨é…ç½®

**æœ€ä½è¦æ±‚ï¼š**
- CPU: 1æ ¸
- å†…å­˜: 1GB
- ç¡¬ç›˜: 10GB
- å¸¦å®½: 1Mbps

**æ¨èé…ç½®ï¼š**
- CPU: 2æ ¸
- å†…å­˜: 2GB
- ç¡¬ç›˜: 20GB
- å¸¦å®½: 2Mbps

### æ“ä½œç³»ç»Ÿæ”¯æŒ

- âœ… Ubuntu 20.04 LTSï¼ˆæ¨èï¼‰
- âœ… Ubuntu 22.04 LTS
- âœ… CentOS 7.x
- âœ… CentOS 8.x / Rocky Linux 8
- âœ… Debian 10/11

### ç½‘ç»œè¦æ±‚

- âœ… å›ºå®šå…¬ç½‘IPåœ°å€
- âœ… èƒ½å¤Ÿè®¿é—®å¾®ä¿¡APIæœåŠ¡å™¨ï¼ˆapi.weixin.qq.comï¼‰
- âœ… å¼€æ”¾ç«¯å£ 3000ï¼ˆTCPï¼‰

## å‡†å¤‡å·¥ä½œ

### 1. è´­ä¹°é˜¿é‡Œäº‘æœåŠ¡å™¨

#### æ¨èæ–¹æ¡ˆï¼šè½»é‡åº”ç”¨æœåŠ¡å™¨

**ä¼˜åŠ¿ï¼š**
- ä»·æ ¼å®æƒ ï¼ˆÂ¥24/æœˆèµ·ï¼‰
- å›ºå®šå…¬ç½‘IP
- é…ç½®ç®€å•
- é€‚åˆå°å‹åº”ç”¨

**è´­ä¹°æ­¥éª¤ï¼š**

1. ç™»å½• [é˜¿é‡Œäº‘æ§åˆ¶å°](https://www.aliyun.com/)
2. è¿›å…¥ **äº§å“ä¸æœåŠ¡** â†’ **è½»é‡åº”ç”¨æœåŠ¡å™¨**
3. é€‰æ‹©é…ç½®ï¼š
   - åœ°åŸŸï¼šå»ºè®®é€‰æ‹© **åä¸œ1ï¼ˆæ­å·ï¼‰** æˆ– **ååŒ—2ï¼ˆåŒ—äº¬ï¼‰**
   - é•œåƒï¼šé€‰æ‹© **Ubuntu 20.04**
   - å¥—é¤ï¼š1æ ¸1GBï¼ˆåŸºç¡€ç‰ˆï¼‰
   - æ—¶é•¿ï¼šæŒ‰éœ€é€‰æ‹©
4. å®Œæˆè´­ä¹°

#### å…¶ä»–æ–¹æ¡ˆï¼šECSäº‘æœåŠ¡å™¨

é€‚åˆæ›´é«˜æ€§èƒ½è¦æ±‚æˆ–éœ€è¦æ›´å¤šå®šåˆ¶çš„åœºæ™¯ã€‚

### 2. è·å–æœåŠ¡å™¨ä¿¡æ¯

è´­ä¹°å®Œæˆåï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

- **å…¬ç½‘IPåœ°å€**ï¼š`123.456.789.012`
- **rootå¯†ç **ï¼šï¼ˆé‡ç½®å¯†ç æˆ–ä½¿ç”¨å¯†é’¥ï¼‰
- **SSHç«¯å£**ï¼šé»˜è®¤ `22`

### 3. é…ç½®å®‰å…¨ç»„

åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š

1. è¿›å…¥æœåŠ¡å™¨ç®¡ç†é¡µé¢
2. ç‚¹å‡» **é˜²ç«å¢™** æˆ– **å®‰å…¨ç»„**
3. æ·»åŠ å…¥æ–¹å‘è§„åˆ™ï¼š
   - ç«¯å£èŒƒå›´ï¼š`3000/3000`
   - æˆæƒå¯¹è±¡ï¼š`0.0.0.0/0`ï¼ˆæ‰€æœ‰IPï¼‰
   - åè®®ç±»å‹ï¼šTCP
   - ç­–ç•¥ï¼šå…è®¸

## è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šè¿æ¥æœåŠ¡å™¨

#### æ–¹æ³•1ï¼šä½¿ç”¨ç»ˆç«¯ï¼ˆMac/Linuxï¼‰

```bash
ssh root@your-server-ip
```

#### æ–¹æ³•2ï¼šä½¿ç”¨ PuTTYï¼ˆWindowsï¼‰

1. ä¸‹è½½å¹¶å®‰è£… [PuTTY](https://www.putty.org/)
2. æ‰“å¼€ PuTTY
3. è¾“å…¥æœåŠ¡å™¨IPåœ°å€
4. ç‚¹å‡» "Open" è¿æ¥
5. è¾“å…¥ç”¨æˆ·åï¼ˆrootï¼‰å’Œå¯†ç 

### æ­¥éª¤2ï¼šä¸Šä¼ éƒ¨ç½²åŒ…

#### æ–¹æ³•1ï¼šä½¿ç”¨ scpï¼ˆMac/Linuxï¼‰

```bash
# åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œ
scp -r deployment-package root@your-server-ip:/opt/
```

#### æ–¹æ³•2ï¼šä½¿ç”¨ FileZillaï¼ˆWindows/Macï¼‰

1. ä¸‹è½½ [FileZilla](https://filezilla-project.org/)
2. åˆ›å»ºæ–°ç«™ç‚¹ï¼š
   - åè®®ï¼šSFTP
   - ä¸»æœºï¼šæœåŠ¡å™¨IP
   - ç«¯å£ï¼š22
   - ç”¨æˆ·ï¼šroot
   - å¯†ç ï¼šæœåŠ¡å™¨å¯†ç 
3. è¿æ¥åï¼Œä¸Šä¼  `deployment-package` åˆ° `/opt/`

### æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–

```bash
# SSH ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ

# 1. è¿›å…¥éƒ¨ç½²ç›®å½•
cd /opt/deployment-package

# 2. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# 3. è¿è¡Œä¸€é”®å®‰è£…è„šæœ¬
sudo ./scripts/setup.sh
```

**å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š**
- æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
- å®‰è£… Node.js 18.x LTS
- å®‰è£… npm åŒ…ç®¡ç†å™¨
- å…¨å±€å®‰è£… PM2
- å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆexpress, corsï¼‰
- é…ç½®ç³»ç»Ÿé˜²ç«å¢™
- åˆ›å»ºå¿…è¦ç›®å½•

**é¢„æœŸè¾“å‡ºï¼š**
```
========================================
  å¾®ä¿¡APIä»£ç†æœåŠ¡å™¨ - ä¸€é”®å®‰è£…
========================================

ğŸ“‹ æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: ubuntu

ğŸ”§ æ­¥éª¤ 1/6: å®‰è£… Node.js 18.x LTS...
âœ… Node.js å®‰è£…å®Œæˆ

ğŸ”§ æ­¥éª¤ 2/6: å®‰è£… PM2 è¿›ç¨‹ç®¡ç†å™¨...
âœ… PM2 å®‰è£…å®Œæˆ

ğŸ”§ æ­¥éª¤ 3/6: å®‰è£…é¡¹ç›®ä¾èµ–...
âœ… ä¾èµ–å®‰è£…å®Œæˆ

ğŸ”§ æ­¥éª¤ 4/6: åˆ›å»ºæ—¥å¿—ç›®å½•...
âœ… ç›®å½•åˆ›å»ºå®Œæˆ

ğŸ”§ æ­¥éª¤ 5/6: é…ç½®é˜²ç«å¢™...
âœ… UFW é˜²ç«å¢™é…ç½®å®Œæˆ

ğŸ”§ æ­¥éª¤ 6/6: é…ç½®ç¯å¢ƒå˜é‡...
âœ… å·²åˆ›å»º .env æ–‡ä»¶

========================================
  âœ… å®‰è£…å®Œæˆï¼
========================================
```

### æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# 1. ç”Ÿæˆè®¤è¯ä»¤ç‰Œ
./scripts/generate-token.sh
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
========================================
  ç”Ÿæˆè®¤è¯ä»¤ç‰Œ
========================================

âœ… å·²ç”Ÿæˆéšæœºä»¤ç‰Œ:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
abcdefgh1234567890ABCDEFGH+/==
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… å·²æ›´æ–° .env æ–‡ä»¶ä¸­çš„ PROXY_AUTH_TOKEN

âš ï¸  é‡è¦æç¤ºï¼š
   1. è¯·å¦¥å–„ä¿ç®¡æ­¤ä»¤ç‰Œï¼Œä¸è¦æ³„éœ²ç»™ä»–äºº
   2. åœ¨åº”ç”¨è®¾ç½®ä¸­é…ç½®æ­¤ä»¤ç‰Œ
```

**âš ï¸ é‡è¦ï¼š** è¯·å¤åˆ¶å¹¶ä¿å­˜è¿™ä¸ªä»¤ç‰Œï¼Œç¨åéœ€è¦åœ¨åº”ç”¨ä¸­é…ç½®ï¼

```bash
# 2. éªŒè¯é…ç½®ï¼ˆå¯é€‰ï¼‰
cat .env
```

### æ­¥éª¤5ï¼šéƒ¨ç½²æœåŠ¡

```bash
./scripts/deploy.sh
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
========================================
  å¾®ä¿¡APIä»£ç†æœåŠ¡å™¨ - éƒ¨ç½²
========================================

ğŸ”„ æ£€æŸ¥ç°æœ‰æœåŠ¡...

ğŸš€ å¯åŠ¨æœåŠ¡...
âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ

ğŸ”§ é…ç½®å¼€æœºè‡ªå¯...
âœ… å¼€æœºè‡ªå¯é…ç½®å®Œæˆ

ğŸ“Š æœåŠ¡çŠ¶æ€:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name           â”‚ status  â”‚ restart â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ wechat-proxy   â”‚ online  â”‚ 0       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸŒ æœåŠ¡å™¨ä¿¡æ¯:
   å…¬ç½‘IP: 123.456.789.012
   ä»£ç†åœ°å€: http://123.456.789.012:3000
   å¥åº·æ£€æŸ¥: http://123.456.789.012:3000/health

========================================
  âœ… éƒ¨ç½²å®Œæˆï¼
========================================
```

### æ­¥éª¤6ï¼šéªŒè¯éƒ¨ç½²

```bash
./scripts/test-proxy.sh
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
========================================
  æµ‹è¯•ä»£ç†æœåŠ¡å™¨
========================================

ğŸ“ æµ‹è¯• 1/4: æœ¬åœ°å¥åº·æ£€æŸ¥...
âœ… æœ¬åœ°å¥åº·æ£€æŸ¥é€šè¿‡
   å“åº”: {"status":"ok","timestamp":"2024-01-01T00:00:00.000Z"}

ğŸ“ æµ‹è¯• 2/4: è·å–æœåŠ¡å™¨å…¬ç½‘IP...
âœ… æœåŠ¡å™¨å…¬ç½‘IP: 123.456.789.012

ğŸ“ æµ‹è¯• 3/4: å¤–ç½‘å¥åº·æ£€æŸ¥...
âœ… å¤–ç½‘å¥åº·æ£€æŸ¥é€šè¿‡

ğŸ“ æµ‹è¯• 4/4: æµ‹è¯•ä»£ç†è½¬å‘åŠŸèƒ½...
âœ… ä»£ç†è½¬å‘åŠŸèƒ½æ­£å¸¸

========================================
  âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
========================================
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# æœåŠ¡å™¨ç›‘å¬ç«¯å£
PORT=3000

# è®¤è¯ä»¤ç‰Œï¼ˆå¿…é¡»ï¼ï¼‰
PROXY_AUTH_TOKEN=your-generated-token-here

# Node è¿è¡Œç¯å¢ƒ
NODE_ENV=production
```

### PM2 é…ç½®ï¼ˆecosystem.config.jsï¼‰

```javascript
module.exports = {
  apps: [{
    name: 'wechat-proxy',              // æœåŠ¡åç§°
    script: './proxy.js',               // å…¥å£æ–‡ä»¶
    instances: 1,                       // å•å®ä¾‹
    autorestart: true,                  // è‡ªåŠ¨é‡å¯
    watch: false,                       // ä¸ç›‘å¬æ–‡ä»¶å˜åŒ–
    max_memory_restart: '200M',         // å†…å­˜é™åˆ¶
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/error.log',     // é”™è¯¯æ—¥å¿—
    out_file: './logs/out.log',         // è¾“å‡ºæ—¥å¿—
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,                   // åˆå¹¶æ—¥å¿—
    min_uptime: '10s',                  // æœ€å°è¿è¡Œæ—¶é—´
    max_restarts: 10,                   // æœ€å¤§é‡å¯æ¬¡æ•°
    restart_delay: 4000                 // é‡å¯å»¶è¿Ÿ
  }]
};
```

## éªŒè¯æµ‹è¯•

### 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show wechat-proxy

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs wechat-proxy
```

### 2. å¥åº·æ£€æŸ¥æµ‹è¯•

```bash
# æœ¬åœ°æµ‹è¯•
curl http://localhost:3000/health

# é¢„æœŸå“åº”ï¼š
# {
#   "status": "ok",
#   "timestamp": "2024-01-01T00:00:00.000Z",
#   "server": "WeChat API Proxy",
#   "version": "1.0.0",
#   "uptime": 123.456
# }
```

### 3. å¤–ç½‘è®¿é—®æµ‹è¯•

```bash
# ä»æœ¬åœ°ç”µè„‘æµ‹è¯•ï¼ˆæ›¿æ¢ä¸ºå®é™…IPï¼‰
curl http://YOUR_SERVER_IP:3000/health
```

### 4. ä»£ç†åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•å¾®ä¿¡APIè½¬å‘
curl -X POST http://localhost:3000/wechat-proxy \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "target_url": "https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=INVALID",
    "method": "GET"
  }'
```

## ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

### 1. é…ç½®æ—¥å¿—è½®è½¬

```bash
# å®‰è£… PM2 æ—¥å¿—è½®è½¬æ¨¡å—
pm2 install pm2-logrotate

# é…ç½®å‚æ•°
pm2 set pm2-logrotate:max_size 10M        # å•æ–‡ä»¶æœ€å¤§10MB
pm2 set pm2-logrotate:retain 7            # ä¿ç•™7å¤©
pm2 set pm2-logrotate:compress true       # å‹ç¼©æ—§æ—¥å¿—
pm2 set pm2-logrotate:rotateInterval '0 0 * * *'  # æ¯å¤©åˆå¤œè½®è½¬
```

### 2. è®¾ç½®ç›‘æ§å‘Šè­¦

```bash
# æ·»åŠ å®šæ—¶ç›‘æ§ä»»åŠ¡
(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/deployment-package/scripts/monitor.sh") | crontab -

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l

# æŸ¥çœ‹ç›‘æ§æ—¥å¿—
tail -f /var/log/wechat-proxy-monitor.log
```

### 3. å¯ç”¨ HTTPSï¼ˆå¯é€‰ï¼‰

**å‡†å¤‡å·¥ä½œï¼š**
- åŸŸåï¼ˆå¦‚ proxy.yourdomain.comï¼‰
- SSLè¯ä¹¦ï¼ˆLet's Encrypt å…è´¹ï¼‰

**å®‰è£… Nginxï¼š**

```bash
# Ubuntu
sudo apt install nginx

# CentOS
sudo yum install nginx
```

**é…ç½® Nginxï¼š**

```bash
sudo nano /etc/nginx/sites-available/wechat-proxy
```

```nginx
server {
    listen 80;
    server_name proxy.yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**å¯ç”¨é…ç½®ï¼š**

```bash
sudo ln -s /etc/nginx/sites-available/wechat-proxy /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

**å®‰è£… SSL è¯ä¹¦ï¼š**

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d proxy.yourdomain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### 4. æ€§èƒ½ä¼˜åŒ–

**è°ƒæ•´ Node.js å‚æ•°ï¼š**

ç¼–è¾‘ `ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'wechat-proxy',
    script: './proxy.js',
    instances: 'max',                   // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
    exec_mode: 'cluster',               // é›†ç¾¤æ¨¡å¼
    max_memory_restart: '500M',         // æé«˜å†…å­˜é™åˆ¶
    // ... å…¶ä»–é…ç½®
  }]
};
```

é‡æ–°éƒ¨ç½²ï¼š

```bash
pm2 reload ecosystem.config.js
```

### 5. å¤‡ä»½é…ç½®

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /opt/deployment-package/scripts/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/wechat-proxy-$DATE.tar.gz \
  /opt/deployment-package/.env \
  /opt/deployment-package/ecosystem.config.js \
  /opt/deployment-package/logs/
echo "Backup created: $BACKUP_DIR/wechat-proxy-$DATE.tar.gz"
EOF

chmod +x /opt/deployment-package/scripts/backup.sh

# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨å¤‡ä»½ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * 0 /opt/deployment-package/scripts/backup.sh") | crontab -
```

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼æ‚¨å·²æˆåŠŸå®Œæˆå¾®ä¿¡APIä»£ç†æœåŠ¡å™¨çš„éƒ¨ç½²ã€‚

**åç»­æ­¥éª¤ï¼š**
1. é…ç½®å¾®ä¿¡å…¬ä¼—å¹³å° IP ç™½åå•
2. åœ¨åº”ç”¨ä¸­é…ç½®ä»£ç†æœåŠ¡å™¨
3. æµ‹è¯•æ¨é€åŠŸèƒ½
4. ç›‘æ§æœåŠ¡è¿è¡ŒçŠ¶æ€

è¯¦è§ [README.md](README.md) å’Œ [docs/wechat-config.md](docs/wechat-config.md)ã€‚
