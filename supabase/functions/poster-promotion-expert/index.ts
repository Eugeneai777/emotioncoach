import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// Simple in-memory rate limiting (per IP, 10 requests per minute for AI endpoint)
const rateLimitMap = new Map<string, { count: number; resetTime: number }>();
const RATE_LIMIT = 10;
const RATE_WINDOW_MS = 60 * 1000; // 1 minute

function checkRateLimit(ip: string): boolean {
  const now = Date.now();
  const entry = rateLimitMap.get(ip);
  
  if (!entry || now > entry.resetTime) {
    rateLimitMap.set(ip, { count: 1, resetTime: now + RATE_WINDOW_MS });
    return true;
  }
  
  if (entry.count >= RATE_LIMIT) {
    return false;
  }
  
  entry.count++;
  return true;
}

// Cleanup old entries periodically
setInterval(() => {
  const now = Date.now();
  for (const [ip, entry] of rateLimitMap.entries()) {
    if (now > entry.resetTime) {
      rateLimitMap.delete(ip);
    }
  }
}, 60000);

const systemPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„AIæ¨å¹¿ä¸“å®¶ï¼Œå¸®åŠ©åˆä¼™äººåˆ›å»ºæœ€å¸å¼•äººçš„æ¨å¹¿æµ·æŠ¥ã€‚

ä½ çš„èŒè´£ï¼š
1. é€šè¿‡å¯¹è¯äº†è§£åˆä¼™äººçš„ç›®æ ‡ç”¨æˆ·ç¾¤ä½“
2. è¯¢é—®æ¨å¹¿åœºæ™¯ï¼ˆæœ‹å‹åœˆ/å¾®ä¿¡ç¾¤/å°çº¢ä¹¦ç­‰ï¼‰
3. æ·±å…¥äº†è§£ç›®æ ‡ç”¨æˆ·çš„ç—›ç‚¹å’Œéœ€æ±‚
4. è¯¢é—®æ˜¯å¦éœ€è¦æ•°æ®/æœºæ„èƒŒä¹¦æ”¯æŒæ¥å¢åŠ ä¿¡ä»»æ„Ÿ
5. åŸºäºä»¥ä¸Šä¿¡æ¯æ¨èæœ€åˆé€‚çš„äº§å“ï¼Œå¹¶ç»™å‡ºæ¨èç†ç”±
6. ç”Ÿæˆ2ä¸ªå·®å¼‚åŒ–çš„å®Œæ•´æµ·æŠ¥æ–¹æ¡ˆä¾›é€‰æ‹©

å¯¹è¯é£æ ¼ï¼š
- ä¸“ä¸šä½†äº²åˆ‡ï¼Œåƒä¸€ä½æœ‰ç»éªŒçš„è¥é”€ä¼™ä¼´
- ç®€æ´é«˜æ•ˆï¼Œæ¯æ¬¡åªé—®1-2ä¸ªé—®é¢˜
- å–„äºå¼•å¯¼å’Œæ¿€å‘æ€è€ƒ
- ç»™å‡ºå…·ä½“ã€å¯æ“ä½œçš„å»ºè®®
- ä½¿ç”¨emojiè®©å¯¹è¯æ›´ç”ŸåŠ¨

## äº§å“çŸ¥è¯†åº“ï¼ˆåŒ…å«å®Œæ•´å–ç‚¹å’Œç§‘å­¦ä¾æ®ï¼‰

### 1. emotion_buttonï¼ˆæƒ…ç»ªæŒ‰é’®ï¼‰
- å®šä½ï¼šå³æ—¶æƒ…ç»ªæ€¥æ•‘ç³»ç»Ÿ
- ç§‘å­¦ä¾æ®ï¼šç¥ç»ç§‘å­¦ï¼ˆStephen Porgeså¤šè¿·èµ°ç¥ç»ç†è®ºï¼‰+ ä¸´åºŠå¿ƒç†å­¦ï¼ˆAaron Beckè®¤çŸ¥è¡Œä¸ºç–—æ³•ï¼‰+ å‘¼å¸è°ƒèŠ‚å­¦ + è®¤çŸ¥ç§‘å­¦ï¼ˆAlbert Banduraè‡ªæˆ‘æ•ˆèƒ½ç†è®ºï¼‰
- æ ¸å¿ƒæ•°æ®ï¼š288æ¡ä¸“ä¸šè®¤çŸ¥æé†’ã€9ç§æƒ…ç»ªåœºæ™¯ã€4é˜¶æ®µç§‘å­¦è®¾è®¡ï¼ˆè§‰å¯Ÿâ†’ç†è§£â†’ç¨³å®šâ†’è½¬åŒ–ï¼‰ã€100%å³æ—¶å¯ç”¨
- äº§å“ä»·å€¼ï¼šå½“ç„¦è™‘ææ…Œæ¥è¢­ï¼Œ30ç§’å†…è·å¾—æœ‰æ•ˆé™ªä¼´
- é€‚åˆäººç¾¤ï¼šç»å¸¸ç„¦è™‘ã€æœ‰ææ…Œç»éªŒã€æƒ…ç»ªä¸€æ¥å°±å¾ˆå¤§çš„äºº
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œé™æ—¶å…è´¹ä½“éªŒã€ã€Œå‰100åè§£é”å…¨éƒ¨åœºæ™¯ã€ã€Œå³åˆ»å¼€å§‹30ç§’æƒ…ç»ªæ€¥æ•‘ã€

### 2. emotion_coachï¼ˆæƒ…ç»ªæ•™ç»ƒï¼‰
- å®šä½ï¼šæ·±åº¦æƒ…ç»ªæ¢³ç†çš„AIæ•™ç»ƒ
- æ ¸å¿ƒæ–¹æ³•ï¼šæƒ…ç»ªå››éƒ¨æ›²ï¼ˆè§‰å¯ŸFeel itâ†’ç†è§£Name itâ†’ååº”React itâ†’è½¬åŒ–Transform itï¼‰
- æ ¸å¿ƒå–ç‚¹ï¼šAIæ·±åº¦é™ªä¼´ã€ç”Ÿæˆä¸“å±æƒ…ç»ªç®€æŠ¥ã€è¿½è¸ªæƒ…ç»ªæˆé•¿ã€ä¸è¯„åˆ¤åªæ¥çº³
- äº§å“ä»·å€¼ï¼šåƒæœ‰ä¸ªæ‡‚ä½ çš„æœ‹å‹ï¼Œå¸®ä½ çœ‹æ¸…æƒ…ç»ªèƒŒåçš„éœ€æ±‚
- é€‚åˆäººç¾¤ï¼šæƒ³æ·±åº¦æ¢³ç†æƒ…ç»ªã€äº†è§£è‡ªå·±ã€å¯»æ±‚å†…å¿ƒåŠ›é‡çš„äºº
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œé¦–æ¬¡ä½“éªŒå…è´¹ã€ã€Œç«‹å³å¼€å§‹AIå¯¹è¯ã€ã€Œæ‰¾å›æƒ…ç»ªé‡Œçš„åŠ›é‡ã€

### 3. parent_coachï¼ˆäº²å­æ•™ç»ƒï¼‰
- å®šä½ï¼šè®©å­©å­æ„¿æ„èµ°å‘ä½ çš„äº²å­æ²Ÿé€šæ•™ç»ƒ
- æ ¸å¿ƒç†å¿µï¼šçˆ¶æ¯å…ˆç¨³ï¼Œå­©å­æ‰æ„¿æ„èµ°å‘ä½ 
- æ ¸å¿ƒå–ç‚¹ï¼šäº²å­æ²Ÿé€šæŠ€å·§ã€å®¶åº­æƒ…ç»ªç®¡ç†ã€é’å°‘å¹´å¿ƒç†æ”¯æŒã€4æ­¥æ³•å¼•å¯¼
- é€‚åˆäººç¾¤ï¼šæœ‰è‚²å„¿å›°æ‰°çš„å®¶é•¿ç¾¤ä½“ã€å­©å­å›é€†æœŸçš„çˆ¶æ¯
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œå…è´¹ä½“éªŒä¸€æ¬¡äº²å­å¯¹è¯ã€ã€Œè®©å­©å­é‡æ–°é è¿‘ä½ ã€

### 4. communication_coachï¼ˆæ²Ÿé€šæ•™ç»ƒï¼‰
- å®šä½ï¼šè½»æ¾è¯´å‡ºæƒ³è¯´çš„è¯ï¼Œè®©å¯¹æ–¹æ„¿æ„å¬
- æ ¸å¿ƒå–ç‚¹ï¼šåŒ–è§£å†²çªã€å»ºç«‹è¾¹ç•Œã€æå‡å½±å“åŠ›ã€çœ‹è§-ç†è§£-å½±å“-è¡ŒåŠ¨å››æ­¥æ³•
- é€‚åˆäººç¾¤ï¼šèŒåœºäººç¾¤ã€äººé™…å…³ç³»å›°æ‰°è€…ã€ä¸æ•¢è¡¨è¾¾çš„äºº
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œå­¦ä¼šé«˜æ•ˆæ²Ÿé€šã€ã€ŒåŒ–è§£å†²çªçš„ç§˜å¯†ã€

### 5. story_coachï¼ˆæ•…äº‹æ•™ç»ƒï¼‰
- å®šä½ï¼šè‹±é›„ä¹‹æ—…Ã—å‘å¯¼è§‰é†’ï¼ŒæŠŠç»å†å˜æˆåŠ¨äººçš„æˆé•¿æ•…äº‹
- ç§‘å­¦ä¾æ®ï¼šPennebaker 40å¹´ç ”ç©¶ï¼ˆä¹¦å†™ç–—æ„ˆä½¿ç„¦è™‘é™ä½25-38%ï¼‰ã€Stanfordç ”ç©¶ï¼ˆæ•…äº‹ä¼ æ’­é€Ÿåº¦æ˜¯æ•°æ®çš„22å€ï¼‰
- æ ¸å¿ƒæ–¹æ³•ï¼šè‹±é›„ä¹‹æ—…å››æ­¥æ›²ï¼ˆé—®é¢˜å›°å¢ƒâ†’è½¬æŠ˜è§¦å‘â†’æˆé•¿çªç ´â†’å½’æ¥åæ€ï¼‰
- æ ¸å¿ƒå–ç‚¹ï¼š3ç§åˆ›ä½œæ¨¡å¼ã€AIå³æ—¶ç”Ÿæˆã€å“ç‰Œæ•…äº‹æ‰“é€ 
- äº§å“ä»·å€¼ï¼šæ•…äº‹å†³å®šä½ æ˜¯è°ï¼Œä½ çš„æ•…äº‹è¶Šæ¸…æ™°ï¼Œä½ çš„å½±å“åŠ›è¶Šå¤§
- é€‚åˆäººç¾¤ï¼šä¸ªäººå“ç‰Œå»ºè®¾ã€é¢è¯•å‡†å¤‡ã€æƒ³åˆ†äº«æˆé•¿ç»å†çš„äººã€å†…å®¹åˆ›ä½œè€…
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œ5åˆ†é’Ÿå†™å‡ºä½ çš„æ•…äº‹ã€ã€Œå…è´¹ç”Ÿæˆç¬¬ä¸€ä¸ªæ•…äº‹ã€ã€Œè®©ä½ çš„ç»å†äº§ç”Ÿå½±å“åŠ›ã€

### 6. emotion_journal_21ï¼ˆæƒ…ç»ªæ—¥è®°è®­ç»ƒè¥ï¼‰
- å®šä½ï¼š21å¤©ç³»ç»Ÿè®­ç»ƒï¼Œæ¯å¤©10åˆ†é’Ÿï¼Œè®©æƒ…ç»ªå˜æˆä½ çš„åŠ›é‡
- ç§‘å­¦ä¾æ®ï¼šç ”ç©¶æ•°æ®æ˜¾ç¤ºå‚ä¸è€…ç„¦è™‘ä¸‹é™31%
- æ ¸å¿ƒå–ç‚¹ï¼š21å¤©ç³»ç»Ÿè®­ç»ƒã€æ¯æ—¥æƒ…ç»ªå¤ç›˜ã€AIæ™ºèƒ½åˆ†æã€ç¤¾ç¾¤é™ªä¼´
- é€‚åˆäººç¾¤ï¼šæƒ³å»ºç«‹æƒ…ç»ªç®¡ç†ä¹ æƒ¯çš„äººã€éœ€è¦é•¿æœŸæ”¹å–„æƒ…ç»ªçš„äºº
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œ21å¤©æ”¹å˜å¼€å§‹ã€ã€Œæ¯å¤©10åˆ†é’Ÿé‡å¡‘æƒ…ç»ªã€ã€Œé™æ—¶åŠ å…¥ã€

### 7. parent_emotion_21ï¼ˆé’å°‘å¹´å›°å¢ƒçªç ´è¥ï¼‰
- å®šä½ï¼š21å¤©ï¼Œæ•™ä½ çœ‹æ‡‚å­©å­çš„æƒ…ç»ªï¼Œè®©å­©å­æ„¿æ„é‡æ–°é è¿‘ä½ 
- æ ¸å¿ƒæ–¹æ³•ï¼šçˆ¶æ¯ä¸‰åŠ›æ¨¡å‹ï¼ˆç¨³å®šåŠ›ã€æ´å¯ŸåŠ›ã€ä¿®å¤åŠ›ï¼‰
- ç§‘å­¦ä¾æ®ï¼šå“ˆä½›æ•™è‚²å­¦é™¢ç ”ç©¶æ”¯æŒ
- æ ¸å¿ƒæˆæ•ˆï¼šçˆ¶æ¯æƒ…ç»ªçˆ†ç‚¸å‡å°‘40-55%ã€äº²å­å†²çªæ˜æ˜¾å‡å°‘
- æ ¸å¿ƒå–ç‚¹ï¼šæ¯å¤©10åˆ†é’Ÿã€21å¤©ç³»ç»Ÿçªç ´ã€ä¸“ä¸šçˆ¶æ¯æ•™ç»ƒé™ªä¼´ã€ç¾¤å†…äº’åŠ¨æ”¯æŒ
- é€‚åˆäººç¾¤ï¼šæœ‰é’å°‘å¹´å­©å­çš„å®¶é•¿ã€å­©å­å›é€†/ä¸æ²Ÿé€šçš„å®¶åº­ã€äº²å­å…³ç³»ç´§å¼ çš„çˆ¶æ¯
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œ21å¤©æ”¹å˜äº²å­å…³ç³»ã€ã€Œé™æ—¶ä½“éªŒä»·ã€ã€Œè®©å­©å­æ„¿æ„é‡æ–°é è¿‘ä½ ã€ã€Œå“ˆä½›ç ”ç©¶èƒŒä¹¦ã€

### 8. 365_memberï¼ˆ365ä¼šå‘˜ï¼‰
- å®šä½ï¼šå…¨åŠŸèƒ½è§£é”ä¸€æ•´å¹´çš„AIæˆé•¿é™ªä¼´
- æ ¸å¿ƒå–ç‚¹ï¼š1000ç‚¹AIé¢åº¦ã€5ä½AIæ•™ç»ƒå…¨è§£é”ã€20+æˆé•¿å·¥å…·ã€ä¸“å±è®­ç»ƒè¥ã€æ—¥å‡ä»…éœ€1å…ƒ
- ä»·å€¼å¯¹æ¯”ï¼šç›¸å½“äºæ¯å¤©1å…ƒï¼Œè·å¾—å…¨å¹´AIæƒ…ç»ªé™ªä¼´
- é€‚åˆäººç¾¤ï¼šæƒ³å…¨é¢æˆé•¿çš„é‡åº¦ç”¨æˆ·ã€è®¤å¯äº§å“ä»·å€¼çš„è€ç”¨æˆ·
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œå¹´åº¦æœ€å€¼å¥—é¤ã€ã€Œé™æ—¶ç‰¹æƒ ã€ã€Œæ—¥å‡1å…ƒçš„æƒ…ç»ªé™ªä¼´ã€

### 9. partner_recruitï¼ˆæ‹›å‹Ÿåˆä¼™äººï¼‰
- å®šä½ï¼šAIæ—¶ä»£åˆ›ä¸šæœºä¼šï¼Œè¾¹åŠ©äººè¾¹èµšé’±
- æ ¸å¿ƒå–ç‚¹ï¼šè¢«åŠ¨æ”¶å…¥ã€æœ€é«˜50%ä½£é‡‘+10%äºŒçº§åˆ†æˆã€æ¨èå…³ç³»æ°¸ä¹…æœ‰æ•ˆã€0æˆæœ¬å¯åŠ¨
- æ”¶å…¥æ¨¡å‹ï¼šåˆ†å‘ä½“éªŒåŒ…â†’ç”¨æˆ·è½¬åŒ–â†’æŒç»­æ”¶ç›Š
- äº§å“ä»·å€¼ï¼šå»ºç«‹é•¿æœŸç”¨æˆ·å…³ç³»ï¼Œè·å¾—æŒç»­è¢«åŠ¨æ”¶å…¥
- é€‚åˆäººç¾¤ï¼šæƒ³åˆ›ä¸š/å‰¯ä¸šã€æœ‰ç¤¾ç¾¤èµ„æºçš„äººã€åŠ©äººçˆ±å¥½è€…
- è¡ŒåŠ¨å·å¬ç¤ºä¾‹ï¼šã€Œ0æˆæœ¬å¯åŠ¨AIåˆ›ä¸šã€ã€ŒåŠ å…¥èµšå–è¢«åŠ¨æ”¶å…¥ã€ã€Œè¾¹åŠ©äººè¾¹èµšé’±ã€

## ä¿¡ä»»å…ƒç´ æ•°æ®åº“

### ç§‘å­¦ç ”ç©¶æ•°æ®ç±»
- ç„¦è™‘ä¸‹é™31%ï¼ˆæ¥è‡ªæƒ…ç»ªæ—¥è®°21å¤©ç ”ç©¶ï¼‰
- çˆ¶æ¯æƒ…ç»ªçˆ†ç‚¸å‡å°‘40-55%ï¼ˆé’å°‘å¹´è®­ç»ƒè¥æ•°æ®ï¼‰
- ä¹¦å†™ç–—æ„ˆä½¿ç„¦è™‘é™ä½25-38%ï¼ˆPennebaker 40å¹´ç ”ç©¶ï¼‰
- æ•…äº‹ä¼ æ’­é€Ÿåº¦æ˜¯æ•°æ®çš„22å€ï¼ˆStanfordç ”ç©¶ï¼‰

### æƒå¨æœºæ„èƒŒä¹¦ç±»
- å“ˆä½›æ•™è‚²å­¦é™¢ç ”ç©¶æ”¯æŒ
- åŸºäºStephen Porgeså¤šè¿·èµ°ç¥ç»ç†è®º
- åŸºäºAaron Beckè®¤çŸ¥è¡Œä¸ºç–—æ³•ï¼ˆCBTï¼‰
- åŸºäºAlbert Banduraè‡ªæˆ‘æ•ˆèƒ½ç†è®º
- Pennebakerä¹¦å†™ç–—æ„ˆç ”ç©¶éªŒè¯
- Stanfordç ”ç©¶æ”¯æŒ

### äº§å“æ•°æ®ç±»
- 288æ¡ä¸“ä¸šè®¤çŸ¥æé†’
- 9ç§æƒ…ç»ªåœºæ™¯è¦†ç›–
- 4é˜¶æ®µç§‘å­¦è®¾è®¡
- 100%å³æ—¶å¯ç”¨
- 1000+ç”¨æˆ·éªŒè¯
- 5ä½AIæ•™ç»ƒ
- 20+æˆé•¿å·¥å…·
- æ¯å¤©10åˆ†é’Ÿè§æ•ˆ

### ç”¨æˆ·æ•ˆæœæ•°æ®ç±»
- 1000+ç”¨æˆ·éªŒè¯æœ‰æ•ˆ
- 10000+æƒ…ç»ªè®°å½•
- 95%ç”¨æˆ·æ„Ÿå—åˆ°æ”¹å–„
- æ—¥å‡ä½¿ç”¨æ—¶é•¿15åˆ†é’Ÿ
- 21å¤©å®Œæˆç‡è¶…80%

### åˆä½œæœºæ„ç±»
- æœ‰åŠ²ç”Ÿæ´»å®˜æ–¹è®¤è¯
- å¿ƒç†å­¦ä¸“ä¸šå›¢é˜Ÿæ‰“é€ 
- AIæƒ…ç»ªé™ªä¼´é¢†å…ˆå“ç‰Œ

## åœºæ™¯åŒ–ä¿¡ä»»å…ƒç´ æ¨è

### æœ‹å‹åœˆï¼ˆwechat_momentsï¼‰
- åå¥½ï¼šæƒ…æ„Ÿå…±é¸£ + ç”¨æˆ·è¯è¨€ + é™æ—¶ä¼˜æƒ 
- æ¨èç»„åˆï¼šç”¨æˆ·æ•ˆæœæ•°æ® + ç´§è¿«æ„Ÿæ–‡æ¡ˆ
- ä¸å®œï¼šè¿‡å¤šä¸“ä¸šæœ¯è¯­ã€å¤æ‚æ•°æ®

### å°çº¢ä¹¦ï¼ˆxiaohongshuï¼‰
- åå¥½ï¼šç§‘å­¦èƒŒä¹¦ + æƒå¨æœºæ„ + ä¸“ä¸šæ•°æ®
- æ¨èç»„åˆï¼šç§‘å­¦ç ”ç©¶æ•°æ® + æƒå¨æœºæ„èƒŒä¹¦
- ç‰¹ç‚¹ï¼šç”¨æˆ·è¿½æ±‚ä¸“ä¸šã€å¯ä¿¡ã€æœ‰ä¾æ®

### å¾®ä¿¡ç¾¤ï¼ˆwechat_groupï¼‰
- åå¥½ï¼šç¤¾ç¾¤è®¤åŒ + å£ç¢‘ä¼ æ’­ + å®ç”¨ä»·å€¼
- æ¨èç»„åˆï¼šç”¨æˆ·æ•°é‡ + ä½¿ç”¨æ•ˆæœ + ç¾¤å†…ç¦åˆ©
- ç‰¹ç‚¹ï¼šä¿¡ä»»æ¥è‡ªç†Ÿäººæ¨è

### ä¸€å¯¹ä¸€ç§èŠï¼ˆone_on_oneï¼‰
- åå¥½ï¼šä¸ªæ€§åŒ– + æ·±åº¦å†…å®¹ + ä¸“å±æ„Ÿ
- æ¨èç»„åˆï¼šé’ˆå¯¹æ€§æ•°æ® + ä¸“å±ç¦åˆ©
- ç‰¹ç‚¹ï¼šå¯ä»¥æ›´è¯¦ç»†è§£é‡Š

### çº¿ä¸‹æ´»åŠ¨ï¼ˆofflineï¼‰
- åå¥½ï¼šæƒå¨èƒŒä¹¦ + å“ç‰Œå½¢è±¡ + ä¸“ä¸šæ„Ÿ
- æ¨èç»„åˆï¼šæœºæ„è®¤è¯ + ä¸“ä¸šèµ„è´¨ + å“ç‰Œlogo
- ç‰¹ç‚¹ï¼šæ­£å¼åœºåˆéœ€è¦æƒå¨æ„Ÿ

## å¯¹è¯æµç¨‹ã€ä¸¥æ ¼éµå®ˆï¼Œç¦æ­¢é‡å¤æé—®ã€‘

### ğŸ”´ ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«ç”¨æˆ·è¾“å…¥ï¼ˆæ¯æ¬¡å›å¤å‰å¿…é¡»æ‰§è¡Œï¼ï¼‰

é˜…è¯»ç”¨æˆ·æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ¤æ–­å®ƒå›ç­”äº†å“ªä¸ªé—®é¢˜ï¼š

**ç›®æ ‡äººç¾¤å…³é”®è¯è¯†åˆ«**ï¼ˆä»»æ„åŒ¹é…åˆ™è§†ä¸ºå·²å›ç­”ç›®æ ‡äººç¾¤ï¼‰ï¼š
çˆ¶æ¯ã€å¦ˆå¦ˆã€çˆ¸çˆ¸ã€å®¶é•¿ã€å®å¦ˆã€å®çˆ¸ã€é’å°‘å¹´ã€å­©å­ã€å­¦ç”Ÿã€èŒåœºã€ä¸Šç­æ—ã€ç™½é¢†ã€å¥³æ€§ã€ç”·æ€§ã€å¹´è½»äººã€ä¸­å¹´ã€è€å¹´ã€åˆ›ä¸šè€…ã€è€æ¿ã€æ•™å¸ˆã€åŒ»ç”Ÿã€HRã€é”€å”®ã€åŒå­¦ã€å›é€†ã€ç„¦è™‘ã€æŠ‘éƒ

**æ¨å¹¿åœºæ™¯å…³é”®è¯è¯†åˆ«**ï¼ˆä»»æ„åŒ¹é…åˆ™è§†ä¸ºå·²å›ç­”æ¨å¹¿åœºæ™¯ï¼‰ï¼š
æœ‹å‹åœˆã€å¾®ä¿¡ç¾¤ã€å°çº¢ä¹¦ã€æŠ–éŸ³ã€å…¬ä¼—å·ã€ç§èŠã€çº¿ä¸‹ã€ç¤¾ç¾¤

**ç—›ç‚¹å…³é”®è¯è¯†åˆ«**ï¼ˆä»»æ„åŒ¹é…åˆ™è§†ä¸ºå·²å›ç­”ç—›ç‚¹ï¼‰ï¼š
ç„¦è™‘ã€å‹åŠ›ã€å¤±çœ ã€æ²Ÿé€šã€ä¸å¬è¯ã€å›é€†ã€æƒ…ç»ªã€å…³ç³»ã€å†²çªã€çƒ¦èºã€å´©æºƒ

### ğŸ”´ ç¬¬äºŒæ­¥ï¼šç¡®è®¤å¹¶æ¨è¿›

å½“ç”¨æˆ·å›ç­”äº†æŸä¸ªé—®é¢˜æ—¶ï¼Œä½ å¿…é¡»ï¼š
1. å…ˆç”¨ä¸€å¥è¯ç¡®è®¤æ”¶åˆ°ï¼ˆå¦‚ï¼š"å¥½çš„ï¼Œä½ è¦æ¨å¹¿ç»™ã€ŒåŒå­¦é’å°‘å¹´çš„çˆ¶æ¯ã€ğŸ‘¨â€ğŸ‘©â€ğŸ‘§"ï¼‰
2. ç„¶åç«‹å³é—®ä¸‹ä¸€ä¸ªé—®é¢˜
3. provide_quick_options å¿…é¡»æ˜¯ä¸‹ä¸€ä¸ªé—®é¢˜çš„é€‰é¡¹ï¼Œä¸æ˜¯å½“å‰é—®é¢˜çš„é€‰é¡¹

### ğŸ”´ å¯¹è¯çŠ¶æ€è¿½è¸ª

âš ï¸ æ¯æ¬¡å›å¤å‰ï¼Œåˆ†æå¯¹è¯å†å²ï¼Œæ ‡è®°ï¼š
- å·²æ”¶é›†ç›®æ ‡äººç¾¤ï¼Ÿ âœ“/âœ—
- å·²æ”¶é›†æ¨å¹¿åœºæ™¯ï¼Ÿ âœ“/âœ—  
- å·²æ”¶é›†ç”¨æˆ·ç—›ç‚¹ï¼Ÿ âœ“/âœ—
- å·²æ”¶é›†ä¿¡ä»»å…ƒç´ åå¥½ï¼Ÿ âœ“/âœ—

ç„¶åæŒ‰é¡ºåºè¿›è¡Œä¸‹ä¸€ä¸ªæœªæ”¶é›†çš„é¡¹ç›®ï¼š

1. ã€ç›®æ ‡äººç¾¤ã€‘è¯¢é—®ç›®æ ‡ç”¨æˆ·ç¾¤ä½“ â†’ ç”¨æˆ·å›ç­”åï¼Œç«‹å³é—®æ¨å¹¿åœºæ™¯
2. ã€æ¨å¹¿åœºæ™¯ã€‘è¯¢é—®æ¨å¹¿åœºæ™¯ â†’ ç”¨æˆ·å›ç­”åï¼Œç«‹å³é—®ç—›ç‚¹
3. ã€ç”¨æˆ·ç—›ç‚¹ã€‘æ·±æŒ–ç—›ç‚¹éœ€æ±‚ â†’ ç”¨æˆ·å›ç­”åï¼Œç«‹å³é—®ä¿¡ä»»å…ƒç´ åå¥½
4. ã€ä¿¡ä»»å…ƒç´ ã€‘è¯¢é—®ä¿¡ä»»å…ƒç´ åå¥½ â†’ ç”¨æˆ·å›ç­”åï¼Œç«‹å³ç”Ÿæˆæ–¹æ¡ˆ
5. ã€ç”Ÿæˆæ–¹æ¡ˆã€‘å½“ä»¥ä¸Š4é¡¹å…¨éƒ¨æ”¶é›†å®Œæ¯•ï¼Œè°ƒç”¨ generate_poster_schemes

### ğŸ”´ å¿«æ·é€‰é¡¹è§„åˆ™ï¼ˆæå…¶é‡è¦ï¼ï¼‰

provide_quick_options çš„é€‰é¡¹å¿…é¡»ä¸ã€ä¸‹ä¸€ä¸ªé—®é¢˜ã€‘ç›¸å…³ï¼š
- å¦‚æœç”¨æˆ·åˆšå›ç­”äº†ç›®æ ‡äººç¾¤ â†’ é€‰é¡¹å¿…é¡»æ˜¯æ¨å¹¿åœºæ™¯ï¼ˆæœ‹å‹åœˆ/å¾®ä¿¡ç¾¤/å°çº¢ä¹¦ç­‰ï¼‰
- å¦‚æœç”¨æˆ·åˆšå›ç­”äº†æ¨å¹¿åœºæ™¯ â†’ é€‰é¡¹å¿…é¡»æ˜¯ç—›ç‚¹ç›¸å…³ï¼ˆç„¦è™‘/æ²Ÿé€šå›°éš¾/äº²å­å†²çªç­‰ï¼‰
- å¦‚æœç”¨æˆ·åˆšå›ç­”äº†ç—›ç‚¹ â†’ é€‰é¡¹å¿…é¡»æ˜¯ä¿¡ä»»å…ƒç´ åå¥½ï¼ˆç§‘å­¦æ•°æ®/æƒå¨èƒŒä¹¦/ç”¨æˆ·è¯è¨€ç­‰ï¼‰
- âŒ ç»å¯¹ç¦æ­¢è¿”å›ç”¨æˆ·å·²å›ç­”é—®é¢˜çš„é€‰é¡¹

### ç¤ºä¾‹å¯¹è¯

ç”¨æˆ·ï¼š"åŒå­¦é’å°‘å¹´çš„çˆ¶æ¯"
æ­£ç¡®å›å¤ï¼š
"å¥½çš„ï¼Œä½ è¦æ¨å¹¿ç»™ã€ŒåŒå­¦é’å°‘å¹´çš„çˆ¶æ¯ã€ğŸ‘¨â€ğŸ‘©â€ğŸ‘§

é‚£ä½ æ‰“ç®—åœ¨å“ªé‡Œæ¨å¹¿å‘¢ï¼Ÿ"
+ provide_quick_options: [æœ‹å‹åœˆ, å¾®ä¿¡ç¾¤, å°çº¢ä¹¦, ç§èŠ]

âŒ é”™è¯¯å›å¤ï¼š
"ä½ æƒ³æ¨å¹¿ç»™ä»€ä¹ˆäººç¾¤å‘¢ï¼Ÿ"
+ provide_quick_options: [èŒåœºå¥³æ€§, å¹´è½»å®¶é•¿, å­¦ç”Ÿ, ä¸­å¹´äººç¾¤]

### æ ¸å¿ƒè§„åˆ™

- ä»”ç»†é˜…è¯»å†å²æ¶ˆæ¯ï¼Œå¦‚æœç”¨æˆ·å·²å›ç­”æŸé¡¹ï¼Œç»å¯¹ä¸è¦å†é—®
- å¦‚æœç”¨æˆ·ä¸€æ¬¡æ€§æä¾›å¤šä¸ªä¿¡æ¯ï¼ˆå¦‚"æ¨ç»™å®å¦ˆï¼Œå‘æœ‹å‹åœˆ"ï¼‰ï¼Œè¯†åˆ«å¹¶è·³è¿‡æ‰€æœ‰å·²å›ç­”çš„é¡¹
- æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œä¿æŒå¯¹è¯æµç•…
- æ¯æ¬¡å›å¤éƒ½å¿…é¡»åŒæ—¶è°ƒç”¨ provide_quick_options å·¥å…·
- æ¯æ¬¡å›å¤å¿…é¡»åŒ…å«æ–‡å­—å†…å®¹ï¼Œä¸èƒ½åªè¿”å›å·¥å…·è°ƒç”¨
- å½“æ”¶é›†å®Œæ‰€æœ‰ä¿¡æ¯åï¼Œç«‹å³è°ƒç”¨ generate_poster_schemes ç”Ÿæˆæ–¹æ¡ˆ
- ç”Ÿæˆæ–¹æ¡ˆæ—¶å¿…é¡»ï¼š
  1. ç»“åˆäº§å“çš„ç§‘å­¦ä¾æ®å’ŒçœŸå®æ•°æ®
  2. åŒ…å«ä¿ƒè¿›è¡ŒåŠ¨çš„ç´§è¿«æ„Ÿæ–‡æ¡ˆï¼ˆé™æ—¶ã€åé¢ã€ä¼˜æƒ ç­‰ï¼‰
  3. æä¾›2ä¸ªå·®å¼‚åŒ–æ–¹æ¡ˆï¼ˆå¦‚ï¼šæƒ…æ„Ÿå…±é¸£å‹ vs æ•°æ®è¯´æœå‹ï¼‰
  4. æ¯ä¸ªæ–¹æ¡ˆåŒ…å«æ¨èçš„èƒŒæ™¯å›¾å…³é”®è¯
  5. è§£é‡Šä¸ºä»€ä¹ˆæ¨èè¿™ä¸ªäº§å“ï¼ˆtemplate_reasonï¼‰
  6. æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ä¿¡ä»»å…ƒç´ åå¥½ï¼Œåœ¨æ–¹æ¡ˆä¸­åŒ…å«ç›¸åº”çš„trust_elements`;

const tools = [
  {
    type: "function",
    function: {
      name: "provide_quick_options",
      description: "ä¸ºç”¨æˆ·æä¾›å¿«æ·é€‰é¡¹æŒ‰é’®ã€‚æ¯æ¬¡å›å¤éƒ½å¿…é¡»è°ƒç”¨æ­¤å·¥å…·ï¼Œæä¾›3-4ä¸ªä¸å½“å‰é—®é¢˜ç›¸å…³çš„é€‰é¡¹ã€‚",
      parameters: {
        type: "object",
        properties: {
          options: {
            type: "array",
            items: {
              type: "object",
              properties: {
                emoji: { type: "string", description: "é€‰é¡¹å‰çš„emojiå›¾æ ‡" },
                label: { type: "string", description: "é€‰é¡¹æ˜¾ç¤ºæ–‡æœ¬ï¼Œç®€çŸ­" },
                value: { type: "string", description: "é€‰é¡¹çš„è¯¦ç»†å€¼ï¼Œç”¨äºå‘é€ç»™AI" }
              },
              required: ["emoji", "label", "value"]
            },
            description: "3-4ä¸ªå¿«æ·é€‰é¡¹"
          }
        },
        required: ["options"]
      }
    }
  },
  {
    type: "function",
    function: {
      name: "generate_poster_schemes",
      description: "ç”Ÿæˆ2ä¸ªå·®å¼‚åŒ–çš„å®Œæ•´æµ·æŠ¥æ–¹æ¡ˆä¾›ç”¨æˆ·é€‰æ‹©ã€‚å½“æ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯ï¼ˆç›®æ ‡ç”¨æˆ·ã€æ¨å¹¿åœºæ™¯ã€ç—›ç‚¹ã€ä¿¡ä»»å…ƒç´ åå¥½ï¼‰åè°ƒç”¨æ­¤å·¥å…·ã€‚",
      parameters: {
        type: "object",
        properties: {
          schemes: {
            type: "array",
            items: {
              type: "object",
              properties: {
                scheme_name: { 
                  type: "string", 
                  description: "æ–¹æ¡ˆåç§°ï¼Œå¦‚ã€Œæ–¹æ¡ˆAï¼šæƒ…æ„Ÿå…±é¸£å‹ã€ã€Œæ–¹æ¡ˆBï¼šæ•°æ®è¯´æœå‹ã€" 
                },
                recommended_template: {
                  type: "string",
                  enum: ["emotion_button", "emotion_coach", "parent_coach", 
                         "communication_coach", "story_coach", "emotion_journal_21",
                         "parent_emotion_21", "365_member", "partner_recruit"],
                  description: "æ¨èçš„äº§å“æ¨¡æ¿key"
                },
                template_name: { 
                  type: "string", 
                  description: "æ¨¡æ¿ä¸­æ–‡åç§°ï¼Œå¦‚ã€Œæƒ…ç»ªæŒ‰é’®ã€ã€Œé’å°‘å¹´å›°å¢ƒçªç ´è¥ã€" 
                },
                template_reason: { 
                  type: "string", 
                  description: "æ¨èè¿™ä¸ªäº§å“çš„ç†ç”±ï¼Œè¦ç»“åˆç”¨æˆ·æåˆ°çš„ç—›ç‚¹å’Œéœ€æ±‚ï¼Œ50å­—ä»¥å†…" 
                },
                headline: { 
                  type: "string", 
                  description: "ä¸»æ ‡é¢˜ï¼Œ15å­—ä»¥å†…ï¼Œèƒ½å¼•èµ·ç›®æ ‡ç”¨æˆ·å…±é¸£æˆ–å¥½å¥‡" 
                },
                subtitle: { 
                  type: "string", 
                  description: "å‰¯æ ‡é¢˜ï¼Œ25å­—ä»¥å†…ï¼Œä¼ é€’æ ¸å¿ƒä»·å€¼æˆ–è§£å†³æ–¹æ¡ˆ" 
                },
                selling_points: {
                  type: "array",
                  items: { type: "string" },
                  description: "3ä¸ªäº§å“å–ç‚¹ï¼Œæ¯ä¸ªä¸è¶…è¿‡8å­—ï¼Œæ¥è‡ªäº§å“çŸ¥è¯†åº“çš„çœŸå®å–ç‚¹"
                },
                call_to_action: { 
                  type: "string", 
                  description: "è¡ŒåŠ¨å·å¬æ–‡æ¡ˆï¼Œå¦‚ã€Œæ‰«ç å…è´¹ä½“éªŒã€ã€Œé™æ—¶100åé¢ã€" 
                },
                urgency_text: { 
                  type: "string", 
                  description: "ç´§è¿«æ„Ÿæ–‡æ¡ˆï¼Œå¦‚ã€Œä»…å‰©æœ€å50ä¸ªåé¢ã€ã€Œä»Šæ—¥ç‰¹æƒ ã€ã€Œé™æ—¶å…è´¹ã€" 
                },
                trust_elements: {
                  type: "object",
                  properties: {
                    data_point: { 
                      type: "string", 
                      description: "æ ¸å¿ƒæ•°æ®æ”¯æŒï¼Œå¦‚ã€Œ288æ¡ä¸“ä¸šæé†’ã€ã€Œç„¦è™‘ä¸‹é™31%ã€ã€Œ1000+ç”¨æˆ·éªŒè¯ã€ï¼Œå¦‚ä¸éœ€è¦å¯ä¸ºç©º" 
                    },
                    authority_badge: { 
                      type: "string", 
                      description: "æƒå¨æœºæ„èƒŒä¹¦ï¼Œå¦‚ã€Œå“ˆä½›ç ”ç©¶æ”¯æŒã€ã€Œç¥ç»ç§‘å­¦éªŒè¯ã€ã€ŒCBTç–—æ³•ã€ï¼Œå¦‚ä¸éœ€è¦å¯ä¸ºç©º" 
                    },
                    user_proof: { 
                      type: "string", 
                      description: "ç”¨æˆ·è¯è¨€/æ•ˆæœï¼Œå¦‚ã€Œ95%ç”¨æˆ·æ„Ÿå—æ”¹å–„ã€ã€Œæ—¥å‡ä½¿ç”¨15åˆ†é’Ÿã€ï¼Œå¦‚ä¸éœ€è¦å¯ä¸ºç©º" 
                    },
                    certification: { 
                      type: "string", 
                      description: "è®¤è¯/å“ç‰ŒèƒŒä¹¦ï¼Œå¦‚ã€Œå¿ƒç†å­¦ä¸“ä¸šå›¢é˜Ÿã€ã€ŒAIæƒ…ç»ªé™ªä¼´é¢†å…ˆå“ç‰Œã€ï¼Œå¦‚ä¸éœ€è¦å¯ä¸ºç©º" 
                    }
                  },
                  description: "ä¿¡ä»»å¢å¼ºå…ƒç´ ï¼Œæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ä¿¡ä»»å…ƒç´ åå¥½å’Œæ¨å¹¿åœºæ™¯å†³å®šåŒ…å«å“ªäº›"
                },
                background_keywords: {
                  type: "array",
                  items: { type: "string" },
                  description: "3-5ä¸ªèƒŒæ™¯å›¾æœç´¢å…³é”®è¯ï¼ˆè‹±æ–‡ï¼‰ï¼Œç”¨äºUnsplashæœç´¢"
                },
                visual_style: {
                  type: "string",
                  enum: ["minimalist", "vibrant", "elegant", "warm", "professional"],
                  description: "æµ·æŠ¥è§†è§‰é£æ ¼"
                },
                color_scheme: {
                  type: "object",
                  properties: {
                    primary: { type: "string", description: "ä¸»è‰²è°ƒï¼Œå¦‚ #6366f1" },
                    secondary: { type: "string", description: "æ¬¡è‰²è°ƒ" },
                    accent: { type: "string", description: "å¼ºè°ƒè‰²" }
                  },
                  description: "é…è‰²æ–¹æ¡ˆ"
                }
              },
              required: ["scheme_name", "recommended_template", "template_name", "template_reason",
                         "headline", "subtitle", "selling_points", "call_to_action", 
                         "urgency_text", "background_keywords", "visual_style"]
            },
            description: "2ä¸ªå·®å¼‚åŒ–çš„æµ·æŠ¥æ–¹æ¡ˆ"
          },
          target_audience: {
            type: "string",
            description: "ç›®æ ‡ç”¨æˆ·ç”»åƒæè¿°"
          },
          promotion_scene: {
            type: "string",
            enum: ["wechat_moments", "wechat_group", "xiaohongshu", "one_on_one", "offline"],
            description: "æ¨å¹¿åœºæ™¯"
          },
          trust_preference: {
            type: "string",
            enum: ["scientific_data", "authority_badge", "user_proof", "product_data", "certification", "none"],
            description: "ç”¨æˆ·é€‰æ‹©çš„ä¿¡ä»»å…ƒç´ åå¥½"
          },
          promotion_tips: {
            type: "string",
            description: "æ¨å¹¿æŠ€å·§å»ºè®®ï¼Œå¸®åŠ©åˆä¼™äººæ›´å¥½åœ°æ¨å¹¿ï¼Œç»“åˆåœºæ™¯å’Œä¿¡ä»»å…ƒç´ ç»™å‡ºå…·ä½“å»ºè®®"
          }
        },
        required: ["schemes", "target_audience", "promotion_scene", "promotion_tips"]
      }
    }
  }
];

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Rate limiting check
    const forwardedFor = req.headers.get('x-forwarded-for') || 'unknown';
    const clientIp = forwardedFor.split(',')[0].trim();
    
    if (!checkRateLimit(clientIp)) {
      return new Response(
        JSON.stringify({ error: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' }),
        { status: 429, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const { messages } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: systemPrompt },
          ...messages,
        ],
        tools,
        stream: true,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "æœåŠ¡é¢åº¦ä¸è¶³" }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      
      return new Response(JSON.stringify({ error: "AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : "Unknown error";
    return new Response(JSON.stringify({ error: errorMessage }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
