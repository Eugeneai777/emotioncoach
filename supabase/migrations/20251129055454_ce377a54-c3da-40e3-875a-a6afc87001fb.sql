-- åˆ›å»ºåˆä¼™äººç›¸å…³è¡¨

-- 1. partners åˆä¼™äººè¡¨
CREATE TABLE partners (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    partner_code TEXT UNIQUE NOT NULL,
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'suspended')),
    
    -- æ¥æº
    source TEXT NOT NULL DEFAULT 'purchase' CHECK (source IN ('purchase', 'manual')),
    source_order_id TEXT,
    source_admin_id UUID,
    source_note TEXT,
    
    -- ææˆæ¯”ä¾‹
    commission_rate_l1 NUMERIC(5,4) NOT NULL DEFAULT 0.30,
    commission_rate_l2 NUMERIC(5,4) NOT NULL DEFAULT 0.10,
    
    -- æ”¶ç›Šç»Ÿè®¡
    total_earnings NUMERIC(12,2) NOT NULL DEFAULT 0,
    available_balance NUMERIC(12,2) NOT NULL DEFAULT 0,
    pending_balance NUMERIC(12,2) NOT NULL DEFAULT 0,
    withdrawn_amount NUMERIC(12,2) NOT NULL DEFAULT 0,
    
    -- æ¨èç»Ÿè®¡
    total_referrals INTEGER NOT NULL DEFAULT 0,
    total_l2_referrals INTEGER NOT NULL DEFAULT 0,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 2. partner_referrals æ¨èå…³ç³»è¡¨
CREATE TABLE partner_referrals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    partner_id UUID NOT NULL REFERENCES partners(id) ON DELETE CASCADE,
    referred_user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    parent_referral_id UUID REFERENCES partner_referrals(id) ON DELETE SET NULL,
    level INTEGER NOT NULL DEFAULT 1 CHECK (level IN (1, 2)),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 3. partner_commissions ä½£é‡‘è®°å½•è¡¨
CREATE TABLE partner_commissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    partner_id UUID NOT NULL REFERENCES partners(id) ON DELETE CASCADE,
    order_id TEXT NOT NULL,
    order_type TEXT NOT NULL,
    source_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    commission_level INTEGER NOT NULL CHECK (commission_level IN (1, 2)),
    order_amount NUMERIC(12,2) NOT NULL,
    commission_rate NUMERIC(5,4) NOT NULL,
    commission_amount NUMERIC(12,2) NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'cancelled')),
    confirm_at TIMESTAMPTZ,
    confirmed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 4. partner_withdrawals æç°è®°å½•è¡¨
CREATE TABLE partner_withdrawals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    partner_id UUID NOT NULL REFERENCES partners(id) ON DELETE CASCADE,
    amount NUMERIC(12,2) NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'rejected')),
    payment_method TEXT NOT NULL CHECK (payment_method IN ('wechat', 'alipay', 'bank')),
    payment_info JSONB NOT NULL,
    admin_note TEXT,
    processed_by UUID,
    processed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 5. partner_benefits åˆä¼™äººæƒç›Šè¡¨
CREATE TABLE partner_benefits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    benefit_name TEXT NOT NULL,
    benefit_description TEXT,
    benefit_value NUMERIC(12,2),
    benefit_icon TEXT DEFAULT 'ğŸ',
    display_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- é¢„ç½®10å¤§æƒç›Šæ•°æ®
INSERT INTO partner_benefits (benefit_name, benefit_description, benefit_value, benefit_icon, display_order) VALUES
('VIPä¼šå‘˜æƒç›Š', 'è§£é”VIPä¼šå‘˜æ‰€æœ‰è¯¾ç¨‹æƒç›Šå’Œå¢å€¼æœåŠ¡', 299, 'ğŸ‘‘', 1),
('èº«ä»½ç»½æ”¾ç‰¹è®­è¥', '4å‘¨çº¿ä¸Šç‰¹è®­è¥ï¼Œæ¢ç´¢èº«ä»½è§‰é†’', 2980, 'ğŸŒŸ', 2),
('æƒ…æ„Ÿç»½æ”¾ç‰¹è®­è¥', '4å‘¨çº¿ä¸Šç‰¹è®­è¥ï¼Œç–—æ„ˆæƒ…æ„Ÿåˆ›ä¼¤', 3980, 'ğŸ’', 3),
('ç”Ÿå‘½ç»½æ”¾ç‰¹è®­è¥', '4å‘¨çº¿ä¸Šç‰¹è®­è¥ï¼Œé‡å¡‘ç”Ÿå‘½èƒ½é‡', 12800, 'ğŸ”¥', 4),
('è‹±é›„ä¹‹æ—…çº¿ä¸‹è¯¾', 'ä¸“å±ç»½æ”¾çº¿ä¸‹è¯¾ç¨‹ä½“éªŒ', 10000, 'ğŸ†', 5),
('ç»½æ”¾æ•™ç»ƒè®¤è¯', 'å›½é™…è®¤è¯ç»½æ”¾æ•™ç»ƒèµ„è´¨', 16800, 'ğŸ“œ', 6),
('ä¸“å±æ¨å¹¿åˆ†æˆ', 'ç›´æ¨30%ï¼ŒäºŒçº§10%æŒç»­æ”¶ç›Š', 0, 'ğŸ’°', 7),
('æ¨å¹¿ç‰©æ–™æ”¯æŒ', 'ä¸“å±æ¨å¹¿ç å’Œæ¨å¹¿æµ·æŠ¥', 0, 'ğŸ¨', 8),
('åˆä¼™äººä¸“å±ç¤¾ç¾¤', 'ä¸å¿—åŒé“åˆä¼™ä¼´å…±åŒæˆé•¿', 0, 'ğŸ‘¥', 9),
('ä¼˜å…ˆå‚ä¸æƒ', 'æ–°è¯¾ç¨‹ã€æ–°æ´»åŠ¨ä¼˜å…ˆå‚ä¸èµ„æ ¼', 0, 'â­', 10);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_partners_user_id ON partners(user_id);
CREATE INDEX idx_partners_partner_code ON partners(partner_code);
CREATE INDEX idx_partners_status ON partners(status);
CREATE INDEX idx_partner_referrals_partner_id ON partner_referrals(partner_id);
CREATE INDEX idx_partner_referrals_referred_user_id ON partner_referrals(referred_user_id);
CREATE INDEX idx_partner_commissions_partner_id ON partner_commissions(partner_id);
CREATE INDEX idx_partner_commissions_status ON partner_commissions(status);
CREATE INDEX idx_partner_commissions_confirm_at ON partner_commissions(confirm_at);
CREATE INDEX idx_partner_withdrawals_partner_id ON partner_withdrawals(partner_id);
CREATE INDEX idx_partner_withdrawals_status ON partner_withdrawals(status);

-- RLS ç­–ç•¥
ALTER TABLE partners ENABLE ROW LEVEL SECURITY;
ALTER TABLE partner_referrals ENABLE ROW LEVEL SECURITY;
ALTER TABLE partner_commissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE partner_withdrawals ENABLE ROW LEVEL SECURITY;
ALTER TABLE partner_benefits ENABLE ROW LEVEL SECURITY;

-- partners ç­–ç•¥
CREATE POLICY "ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„åˆä¼™äººä¿¡æ¯"
ON partners FOR SELECT
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„åˆä¼™äººä¿¡æ¯"
ON partners FOR UPDATE
TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åˆä¼™äºº"
ON partners FOR SELECT
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰åˆä¼™äºº"
ON partners FOR ALL
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role))
WITH CHECK (has_role(auth.uid(), 'admin'::app_role));

-- partner_referrals ç­–ç•¥
CREATE POLICY "åˆä¼™äººå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æ¨èå…³ç³»"
ON partner_referrals FOR SELECT
TO authenticated
USING (EXISTS (
    SELECT 1 FROM partners 
    WHERE partners.id = partner_referrals.partner_id 
    AND partners.user_id = auth.uid()
));

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ¨èå…³ç³»"
ON partner_referrals FOR SELECT
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

CREATE POLICY "ç³»ç»Ÿå¯ä»¥åˆ›å»ºæ¨èå…³ç³»"
ON partner_referrals FOR INSERT
TO authenticated
WITH CHECK (true);

-- partner_commissions ç­–ç•¥
CREATE POLICY "åˆä¼™äººå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„ä½£é‡‘"
ON partner_commissions FOR SELECT
TO authenticated
USING (EXISTS (
    SELECT 1 FROM partners 
    WHERE partners.id = partner_commissions.partner_id 
    AND partners.user_id = auth.uid()
));

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä½£é‡‘"
ON partner_commissions FOR SELECT
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

CREATE POLICY "ç³»ç»Ÿå¯ä»¥åˆ›å»ºä½£é‡‘è®°å½•"
ON partner_commissions FOR INSERT
TO authenticated
WITH CHECK (true);

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥ç®¡ç†ä½£é‡‘"
ON partner_commissions FOR UPDATE
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

-- partner_withdrawals ç­–ç•¥
CREATE POLICY "åˆä¼™äººå¯ä»¥æŸ¥çœ‹è‡ªå·±çš„æç°è®°å½•"
ON partner_withdrawals FOR SELECT
TO authenticated
USING (EXISTS (
    SELECT 1 FROM partners 
    WHERE partners.id = partner_withdrawals.partner_id 
    AND partners.user_id = auth.uid()
));

CREATE POLICY "åˆä¼™äººå¯ä»¥åˆ›å»ºæç°ç”³è¯·"
ON partner_withdrawals FOR INSERT
TO authenticated
WITH CHECK (EXISTS (
    SELECT 1 FROM partners 
    WHERE partners.id = partner_withdrawals.partner_id 
    AND partners.user_id = auth.uid()
));

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æç°"
ON partner_withdrawals FOR SELECT
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥ç®¡ç†æç°"
ON partner_withdrawals FOR UPDATE
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role));

-- partner_benefits ç­–ç•¥
CREATE POLICY "æ‰€æœ‰ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æƒç›Š"
ON partner_benefits FOR SELECT
TO authenticated
USING (is_active = true);

CREATE POLICY "ç®¡ç†å‘˜å¯ä»¥ç®¡ç†æƒç›Š"
ON partner_benefits FOR ALL
TO authenticated
USING (has_role(auth.uid(), 'admin'::app_role))
WITH CHECK (has_role(auth.uid(), 'admin'::app_role));

-- æ›´æ–° updated_at è§¦å‘å™¨
CREATE TRIGGER update_partners_updated_at
BEFORE UPDATE ON partners
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();